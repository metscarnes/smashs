<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¥© SMASHS - Ta Rencontre Charnelle</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/metscarnes/bimi-metscarnes/main/Logo%20Mets%20Carn%C3%A9s%20HD.png">
    <link href="https://db.onlinewebfonts.com/c/194ce65461099b38279d03e32740d78e?family=Loyola+Pro+Bold" rel="stylesheet" type="text/css"/>
    <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <!-- ========================================================== -->
    <!-- ============== BLOC 1 : STYLES CSS COMPLET ============== -->
    <!-- ========================================================== -->
    <style>
        :root { --primary: #edc196; --accent: #cc8956; --dark: #040508; --dark-secondary: #50241c; --text-light: #edc196; --text-secondary: rgba(237, 193, 150, 0.7); --border-subtle: rgba(204, 137, 86, 0.2); --glow: rgba(237, 193, 150, 0.4); --transition-speed-fast: 0.4s; --transition-speed-medium: 0.6s; --transition-speed-slow: 1s; --transition-easing: cubic-bezier(0.25, 1, 0.5, 1); }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; background: var(--dark); }
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=- DÃ‰BUT BLOC AJOUTÃ‰ : SCROLL CIBLÃ‰ MOBILE =-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

/* Cette classe sera ajoutÃ©e/retirÃ©e par JavaScript pour autoriser le scroll UNIQUEMENT sur les Ã©crans de profil/rÃ©sultats */
body.body-scroll-enabled {
    overflow-y: auto; /* âœ… Autorise le dÃ©filement vertical */
    -webkit-overflow-scrolling: touch; /* âœ… Assure un dÃ©filement fluide sur iOS */
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN BLOC AJOUTÃ‰ : SCROLL CIBLÃ‰ MOBILE =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
        body { font-family: 'Playpen Sans', sans-serif; color: var(--text-light); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body::before { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: -1; opacity: 0.6; }
        h1, h2, h3, h4, .btn { font-family: 'Loyola Pro Bold', serif; color: var(--primary); }
        .view-container { position: fixed; inset: 0; opacity: 0; pointer-events: none; transform: scale(1.05); transition: opacity var(--transition-speed-medium) ease, transform var(--transition-speed-medium) ease; display: flex; justify-content: center; align-items: center; padding: 1rem; overflow-y: auto; }
        .view-container.is-visible { opacity: 1; pointer-events: auto; transform: scale(1); }
        .btn { background: var(--accent); color: var(--dark); border: none; padding: 1.2rem 3rem; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 30px rgba(204, 137, 86, 0.3); letter-spacing: 1px; text-transform: uppercase; }
        .btn:hover { background: var(--primary); transform: translateY(-3px); box-shadow: 0 12px 40px rgba(237, 193, 150, 0.4); }
        #welcome-screen { background: linear-gradient(135deg, var(--dark) 0%, #0a0a0c 50%, var(--dark-secondary) 100%); z-index: 100; }
        .welcome-content { text-align: center; max-width: 900px; animation: slideUp 1.4s cubic-bezier(0.16, 1, 0.3, 1) 0.3s backwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(80px); } to { opacity: 1; transform: translateY(0); } }
        .welcome-logo { margin-bottom: 3rem; filter: drop-shadow(0 20px 60px rgba(237, 193, 150, 0.5)); animation: float 5s ease-in-out infinite; }
        .welcome-logo img { width: 120px; height: auto; }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(-3deg) scale(1); } 50% { transform: translateY(-30px) rotate(3deg) scale(1.05); } }
        .welcome-title { font-size: clamp(2.5rem, 8vw, 5.5rem); margin-bottom: 2rem; letter-spacing: 3px; text-transform: uppercase; text-shadow: 0 5px 30px rgba(237, 193, 150, 0.4); line-height: 1.1; }
        .welcome-title::after { content: ''; display: block; width: 120px; height: 3px; background: linear-gradient(90deg, transparent, var(--accent), transparent); margin: 1.5rem auto 0; animation: lineGrow 1.5s ease-out 0.8s backwards; }
        @keyframes lineGrow { from { width: 0; opacity: 0; } to { width: 120px; opacity: 1; } }
        .welcome-description { color: var(--text-secondary); font-size: 1.2rem; line-height: 2; margin-bottom: 3rem; font-weight: 300; font-style: italic; }
        .btn-welcome { padding: 1.6rem 3.5rem; font-size: 1.1rem; border: none; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); letter-spacing: 1.5px; text-transform: uppercase; background: var(--accent); color: var(--dark); box-shadow: 0 10px 40px rgba(204, 137, 86, 0.4); position: relative; overflow: hidden; }
        .btn-welcome::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: left 0.6s; }
        .btn-welcome:hover::before { left: 100%; }
        .btn-welcome:hover { background: var(--primary); transform: translateY(-4px); box-shadow: 0 15px 50px rgba(237, 193, 150, 0.6); }
        #app { z-index: 50; }
        .container { width: 100%; max-width: 1200px; margin: auto; background: linear-gradient(135deg, var(--dark-secondary) 0%, rgba(4, 5, 8, 0.95) 100%); box-shadow: 0 40px 120px rgba(0, 0, 0, 0.8), 0 0 1px 1px var(--border-subtle); padding: 2rem 4rem; border: 1px solid var(--border-subtle); position: relative; opacity: 0; transform: translateY(20px); transition: opacity var(--transition-speed-medium) var(--transition-easing), transform var(--transition-speed-medium) var(--transition-easing); }
        #app.is-visible .container { opacity: 1; transform: translateY(0); }
        .container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--accent), transparent); opacity: 0.5; }
.header {
    display: flex;
    justify-content: center; /* âœ… Centre le titre horizontalement */
    align-items: center;
    margin-bottom: 3rem;
    position: relative; /* âœ… Contexte de positionnement pour les boutons */
}

        .header .header-actions {
    position: absolute; /* âœ… Sort les boutons du flux normal */
    top: 50%; /* âœ… Aligne verticalement */
    transform: translateY(-50%); /* âœ… Ajustement fin de l'alignement vertical */
    width: 100%; /* âœ… Fait en sorte que le conteneur prenne toute la largeur */
    display: flex; /* âœ… Utilise flex pour positionner les boutons Ã  l'intÃ©rieur */
    justify-content: space-between; /* âœ… Pousse les boutons aux extrÃ©mitÃ©s */
    pointer-events: none; /* âœ… EmpÃªche le conteneur de bloquer les clics sur le titre */
}
.header .header-actions .btn-icon {
    pointer-events: auto; /* âœ… RÃ©active les clics sur les boutons eux-mÃªmes */
}
.header .main-title-wrapper {
    text-align: center;
    display: flex; /* âœ… Active le mode flex */
    flex-direction: column; /* âœ… Aligne les enfants verticalement */
    align-items: center; /* âœ… Centre les enfants horizontalement */
    gap: 0.5rem; /* âœ… Ajoute un petit espace entre le sous-titre et le bouton */
}
        .btn-icon { background: rgba(237, 193, 150, 0.05); border: 1px solid var(--border-subtle); width: 44px; height: 44px; font-size: 1.2rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
        .btn-icon:hover { border-color: var(--accent); background: rgba(204, 137, 86, 0.15); transform: translateY(-2px); color: var(--primary); }
        .main-title { font-size: clamp(2rem, 5vw, 2.8rem); margin: 0; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 4px 20px rgba(237, 193, 150, 0.3); }
        .subtitle { font-size: 1.1rem; color: var(--text-secondary); font-weight: 300; font-style: italic; }
        .screen { display: none; min-height: 60vh; }
        .screen.active { display: block; animation: content-entry 0.6s var(--transition-easing) forwards; }
        .screen.is-exiting { opacity: 0; transform: translateY(-20px); pointer-events: none; transition: opacity 0.4s ease-out, transform 0.4s ease-out; }
        @keyframes content-entry { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #intro-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 2rem; }
        #dialogue { font-size: 1.6rem; line-height: 1.8; max-width: 700px; transition: opacity 0.8s ease; }
        .inputs, .buttons { display: flex; gap: 1.5rem; align-items: center; }
        .inputs { flex-direction: column; opacity: 0; transition: opacity 0.8s ease; }
        .btn-genre { font-family: 'Playpen Sans', sans-serif; font-size: 1.1rem; padding: 1rem 2.2rem; border: 1px solid var(--border-subtle); background: transparent; color: var(--text-light); cursor: pointer; transition: all 0.3s ease; }
        .btn-genre:hover, .btn-genre.selected { border-color: var(--accent); background: rgba(204, 137, 86, 0.2); transform: translateY(-2px); }
        input[type="text"] { background: rgba(80, 36, 28, 0.3); border: 1px solid var(--border-subtle); color: var(--text-light); padding: 1rem 1.5rem; font-size: 1.1rem; width: 100%; max-width: 350px; text-align: center; font-family: 'Playpen Sans', sans-serif; transition: all 0.3s ease; }
        input[type="text"]:focus { outline: none; border-color: var(--accent); background: rgba(80, 36, 28, 0.5); box-shadow: 0 0 0 3px rgba(204, 137, 86, 0.15); }
        #question-flow.active { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; flex-grow: 1; }
        #q-progress { font-size: 0.85rem; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 2rem; }
        #q-text { font-size: clamp(1.8rem, 5vw, 2.6rem); margin: 1rem 0 0.5rem; line-height: 1.3; }
        .question-helper { color: var(--text-secondary); font-size: 1.05rem; margin-bottom: 2.5rem; font-weight: 300; font-style: italic; }
        .answers { display: grid; gap: 1.2rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); width: 100%; }
        .answer-card { background: rgba(80, 36, 28, 0.3); border: 1px solid var(--border-subtle); padding: 1.6rem; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); user-select: none; position: relative; overflow: hidden; text-align: center; }
        .answer-card:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6); background: rgba(237, 193, 150, 0.05); }
        .answer-card.selected { border-color: var(--accent); background: rgba(204, 137, 86, 0.2); transform: translateY(-5px); box-shadow: 0 10px 40px rgba(204, 137, 86, 0.3); }
        .answer-card .icon { font-size: 3.5rem; display: block; filter: drop-shadow(0 4px 10px rgba(237, 193, 150, 0.2)); margin-bottom: 1rem; }
        .answer-card .text { font-weight: 600; font-size: 1.1rem; line-height: 1.6; color: var(--text-light); }
        .answer-card.small-text .text { font-size: 0.95rem; }
        .answer-card.selected::after { content: 'âœ“'; position: absolute; top: -12px; right: -12px; width: 34px; height: 34px; background: var(--accent); color: var(--dark); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; box-shadow: 0 6px 20px rgba(204, 137, 86, 0.6); border: 2px solid var(--dark); animation: checkmarkPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes checkmarkPop { 0% { transform: scale(0) rotate(-180deg); } 50% { transform: scale(1.2) rotate(10deg); } 100% { transform: scale(1) rotate(0deg); } }
        #swipe-screen.active { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 1rem; }
.card-deck {
  position: relative;
  width: 100%;
  max-width: 450px;
  height: 500px;
  max-height: 55vh;
  margin-bottom: 0.5rem; /* âœ… Marge infÃ©rieure rÃ©duite pour remonter les boutons d'action */
  overflow: visible; /* Allow expanded cards to overflow the deck container */
}

.card {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: #1a1614;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  border: 1px solid var(--border-subtle);
  opacity: 0;
  transform: scale(0.95);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  pointer-events: none;
  user-select: none;
  border-radius: 20px;
  overflow: visible; /* allow info area to grow outside when expanded */
  touch-action: pan-y;
  will-change: transform;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
        .card:hover { transform: scale(1.02); box-shadow: 0 15px 50px rgba(0,0,0,0.5); }
        .card.is-next { opacity: 0.5; transform: scale(0.95); }
        .card.is-active { opacity: 1; transform: scale(1); cursor: grab; pointer-events: auto; z-index: 10; }
        .card-choice { position: absolute; top: 50%; transform: translateY(-50%); opacity: 0; transition: opacity 0.3s ease; z-index: 10; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.5)); font-size: 3rem; font-weight: bold; text-transform: uppercase; letter-spacing: 4px; padding: 0.5rem 1rem; border: 5px solid; }
        .card-choice.like { left: 30px; color: #4caf50; border-color: #4caf50; transform: translateY(-50%) rotate(-15deg); }
        .card-choice.nope { right: 30px; color: #f44336; border-color: #f44336; transform: translateY(-50%) rotate(15deg); }
        .card-gradient-overlay { position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(to top, rgba(26, 22, 20, 0.95) 0%, rgba(26, 22, 20, 0.7) 40%, transparent 100%); pointer-events: none; }
        .card-sensor-bars { position: absolute; top: 0; left: 0; right: 0; display: grid !important; grid-template-columns: repeat(4, 1fr); align-items: center; justify-items: center; gap: 10px; padding: 8px 15px; background: rgba(0, 0, 0, 0.45); border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 5; height: 60px; }
        .thermo-line { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; width: 100%; opacity: 0; animation: fadeInThermo 0.5s ease forwards; animation-delay: var(--delay, 0s); }
        .thermo-bar-row { display: flex; align-items: center; justify-content: center; gap: 6px; width: 90%; }
        .thermo-icon { font-size: 1rem; flex-shrink: 0; }
        .thermo-bar-container { flex: 1; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; overflow: hidden; position: relative; }
        .thermo-bar-fill { height: 100%; border-radius: 3px; width: 0%; transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1); animation: fillProgress 1.4s ease forwards; animation-delay: var(--delay, 0s); }
        .thermo-text { font-size: 0.75rem; font-weight: 500; color: rgba(237,193,150,0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.4); margin-top: 3px; text-align: center; letter-spacing: 0.3px; }
        @keyframes fillProgress { from { width: 0%; } to { width: var(--target-width); } }
        @keyframes fadeInThermo { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
        .thermo-bar-fill { animation-name: fillProgress, pulseBar; animation-duration: 1.4s, 3s; animation-timing-function: ease, ease-in-out; animation-iteration-count: 1, infinite; animation-delay: var(--delay, 0s), calc(var(--delay, 0s) + 1s); }
        @keyframes pulseBar { 0%,100% { filter: brightness(1); } 50% { filter: brightness(1.3); } }

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC FINAL : .card-info et expansion ========= */
/* ========================================================== */

.card {
    transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* âœ… C'est LA clÃ© : on anime la hauteur de la carte entiÃ¨re */
}
.card.is-expanded {
    height: 580px; /* âœ… On donne une grande hauteur Ã  la carte une fois dÃ©ployÃ©e */
}

.card-gradient-overlay {
    height: 50%;
    transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.card.is-expanded .card-gradient-overlay {
    height: 75%; /* âœ… Le dÃ©gradÃ© s'agrandit pour une meilleure lisibilitÃ© */
}

/* âœ… La solution : on ancre bien par le bas et on anime la HAUTEUR du bloc d'info */
.card-info {
  /* Make the info area part of the document flow so it can grow naturally */
  position: relative;
  padding: 20px;
  color: #f5f1e8;
  z-index: 6;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  max-height: 180px; /* compact by default */
  overflow: hidden; /* hide overflow when collapsed */
  transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  background: linear-gradient(180deg, rgba(26,22,20,0) 0%, rgba(26,22,20,0) 60%); /* neutral background so text is readable */
}
.card.is-expanded .card-info {
  max-height: 1000px; /* allow to expand to full content */
}

/* New media area: fixed height, background image lives here so the info can expand beneath */
.card-media {
  width: 100%;
  height: 320px; /* fixed visual image area */
  min-height: 220px;
  max-height: 420px;
  background-size: cover;
  background-position: center;
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
}
.card.is-expanded .card-media {
  /* keep the media height constant so it doesn't overlap the info on expand */
  height: 320px;
}

.card-info-content {
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
}

.card-text-wrapper {
    flex-grow: 1;
  min-width: 0; /* allow the text to shrink instead of forcing the card wider */
}

.card-name {
    font-size: 1.8rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    letter-spacing: -0.5px;
}

.card-location {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.95rem;
    color: rgba(245,241,232,0.85);
    margin-bottom: 12px;
}

/* âœ… On affiche bien une seule ligne par dÃ©faut */
.card-bio {
    margin: 12px 0 0;
    font-size: 0.95rem;
    line-height: 1.5;
    color: rgba(245,241,232,0.9);
    font-style: italic;
    text-shadow: 0 1px 3px rgba(0,0,0,0.6);
  display: -webkit-box;
  line-clamp: 1;
  -webkit-line-clamp: 1; /* âœ… Une seule ligne visible, avec "..." automatique */
  -webkit-box-orient: vertical;
    overflow: hidden;
    transition: all 0.4s ease;
}

.card.is-expanded .card-bio {
  line-clamp: 20;
  -webkit-line-clamp: 20; /* âœ… On retire la limite pour tout afficher */
}

.card-expand-chevron {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    margin-top: 2px;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.card.is-expanded .card-expand-chevron {
    transform: rotate(180deg); /* âœ… La flÃ¨che tourne */
}

.card-details-arrow {
    display: none;
}

.card-external-link {
    display: inline-block;
    background: var(--accent);
    color: var(--dark);
    text-decoration: none;
    padding: 0.8rem 1.5rem;
    font-family: 'Loyola Pro Bold', serif;
    font-size: 0.9rem;
    text-align: center;
    border-radius: 4px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.4);
    transition: opacity 0.4s ease, transform 0.4s ease;
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
}

.card-external-link:hover {
    background: var(--primary);
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 30px rgba(0,0,0,0.5);
}

.card.is-expanded .card-external-link {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

/* ========================================================== */
/* ========= FIN DU BLOC FINAL : .card-info et expansion ========= */
/* ========================================================== */
        .card-details-arrow { font-size: 2rem; cursor: pointer; color: white; background: rgba(255,255,255,0.2); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; flex-shrink: 0; }
        .card-details-arrow:hover { transform: scale(1.1); }
        .profile-radar-container { width: 150px; height: 150px; position: relative; }
        .profile-radar-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); }
        .actions { display: flex; gap: 1rem; justify-content: center; align-items: center; }
        .action-btn { background: #23272f; border: none; color: white; box-shadow: 0 5px 20px rgba(0,0,0,0.3); border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.3s ease; }
        .action-btn:hover { transform: scale(1.1); }
        .action-btn.undo { color: #f9b930; font-size: 1.5rem; width: 60px; height: 60px; }
        .action-btn.dislike { color: #fe5269; font-size: 2.5rem; width: 70px; height: 70px; }
        .action-btn.like { color: #2de9a1; font-size: 2rem; width: 70px; height: 70px; }
        #results-screen h1, #profile-screen h1 { text-align: center; margin-bottom: 2rem; }
        #matches-list { max-width: 800px; margin: 0 auto; }
        .match-item { background: rgba(80, 36, 28, 0.3); border: 1px solid var(--border-subtle); padding: 2rem; margin-bottom: 1.5rem; transition: all 0.3s ease; }
        .match-item:hover { background: rgba(80, 36, 28, 0.5); transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .match-item h3 { font-size: 1.8rem; margin-bottom: 1rem; }
        .match-item p { color: var(--text-secondary); line-height: 1.7; margin-bottom: 1rem; }
        .match-item a { color: var(--accent); text-decoration: none; font-weight: 600; transition: color 0.3s; }
        .match-item a:hover { color: var(--primary); }
        .results-actions { display: flex; gap: 1rem; justify-content: center; margin-top: 3rem; flex-wrap: wrap; }
        #loading-screen { background: transparent; z-index: 200; }
        #loading-screen::before, #loading-screen::after { content: ''; position: absolute; top: 0; width: 50.5%; height: 100%; background: var(--dark-secondary); z-index: 2; transition: transform var(--transition-speed-slow) cubic-bezier(0.77, 0, 0.175, 1); box-shadow: 5px 0 30px rgba(0, 0, 0, 0.5); }
        #loading-screen::before { left: 0; }
        #loading-screen::after { right: 0; }
        #loading-screen.is-opening::before { transform: translateX(-100%); }
        #loading-screen.is-opening::after { transform: translateX(100%); }
        .loading-content { position: relative; z-index: 3; text-align: center; width: 100%; display: flex; justify-content: center; align-items: center; min-height: 200px; }
        .loading-phase-1, .loading-phase-2 { transition: opacity 0.5s ease-out, transform 0.5s ease-out; position: absolute; width: 90%; max-width: 400px; }
        #loading-screen .loading-phase-2 { opacity: 0; transform: translateY(20px); pointer-events: none; }
        #loading-screen.is-finished .loading-phase-1 { opacity: 0; transform: scale(0.95); pointer-events: none; }
        #loading-screen.is-finished .loading-phase-2 { opacity: 1; transform: translateY(0); pointer-events: auto; }
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT DU BLOC CORRIGÃ‰ : Animation du chargement =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

.loading-text {
    font-size: clamp(1.2rem, 4vw, 1.8rem);
    margin-bottom: 2rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    text-shadow: 0 2px 15px var(--glow);
    /* animation: textFadeInOut 1.5s ease-in-out infinite; */ /* âœ… Ligne supprimÃ©e pour laisser le JavaScript gÃ©rer l'animation sÃ©quentielle. */
}

/* L'animation @keyframes textFadeInOut a Ã©tÃ© entiÃ¨rement supprimÃ©e car elle n'est plus nÃ©cessaire. */

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN DU BLOC CORRIGÃ‰ : Animation du chargement =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
        .loading-bar-container { width: 100%; max-width: 300px; height: 4px; background: rgba(237, 193, 150, 0.2); overflow: hidden; margin: 0 auto; }
        .loading-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent) 0%, var(--primary) 100%); box-shadow: 0 0 20px var(--glow); }
        .reveal-button { font-size: 1.2rem; letter-spacing: 2px; text-transform: uppercase; color: var(--primary); background: transparent; border: 2px solid var(--accent); padding: 1.2rem 3rem; cursor: pointer; transition: all 0.4s ease; font-family: 'Loyola Pro Bold', serif; }
        .reveal-button:hover { color: var(--dark); background: var(--primary); border-color: var(--primary); box-shadow: 0 0 30px var(--glow); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(4, 5, 8, 0.85); backdrop-filter: blur(8px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity var(--transition-speed-fast) ease; }
        .modal-overlay.is-visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--dark-secondary); padding: 2.5rem; width: 90%; max-width: 500px; border: 1px solid var(--border-subtle); box-shadow: 0 30px 100px rgba(0, 0, 0, 0.8); transform: scale(0.95); transition: transform var(--transition-speed-fast) var(--transition-easing); max-height: 90vh; overflow-y: auto; position: relative; text-align: center; }
        .modal-overlay.is-visible .modal-content { transform: scale(1); }
        #alert-modal-title { font-size: 1.8rem; margin-bottom: 1rem; letter-spacing: 1px; text-transform: uppercase; }
        #alert-modal-text { font-size: 1.1rem; line-height: 1.8; margin-bottom: 2rem; color: var(--text-secondary); }
        .modal-btn { padding: 1rem 2.5rem; font-size: 1rem; border: none; cursor: pointer; transition: all 0.3s ease; letter-spacing: 1px; text-transform: uppercase; font-family: 'Loyola Pro Bold', serif; }
        .modal-btn-confirm { background: var(--accent); color: var(--dark); box-shadow: 0 6px 20px rgba(204, 137, 86, 0.4); }
        .modal-btn-confirm:hover { background: var(--primary); transform: translateY(-2px); box-shadow: 0 8px 30px rgba(237, 193, 150, 0.5); }
        .modal-btn-secondary { background: transparent; border: 1px solid var(--border-subtle); color: var(--text-light); }
        .modal-btn-secondary:hover { background: rgba(237, 193, 150, 0.1); border-color: var(--accent); }
        #alert-modal-buttons { display: flex; gap: 1rem; justify-content: center; }
        #alert-modal-buttons .modal-btn { flex-grow: 1; }
        #product-modal-overlay .modal-content { background: linear-gradient(135deg, var(--dark) 0%, #1a1614 100%); border: 1px solid var(--border-subtle); border-radius: 0; padding: 2rem 2.5rem; max-width: 900px; font-family: 'Playpen Sans', sans-serif; color: var(--text-secondary); line-height: 1.7; }
        .product-title { font-size: 2.2rem; color: var(--primary); text-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); letter-spacing: 1px; position: relative; display: inline-block; margin-bottom: 1rem; }
        .product-title::after { content: ''; position: absolute; bottom: -8px; left: 0; width: 60px; height: 3px; background: linear-gradient(90deg, var(--accent), transparent); }
        .profile-header { display: flex; align-items: center; gap: 1.5rem; border-bottom: 1px solid var(--border-subtle); padding-bottom: 1.5rem; margin-bottom: 2rem; }
        .profile-image { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-subtle); box-shadow: 0 5px 20px rgba(0,0,0,0.4); flex-shrink: 0; }

    /* Profile screen: ensure content fits viewport and action buttons are visible on small screens */
    #profile-screen .profile-container {
      text-align: center;
      max-width: 700px;
      margin: auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      min-height: calc(100vh - 140px); /* leave space for header / safe-area */
      padding: 1rem 0 1.5rem;
    }

    #profile-screen .profile-actions-group {
      margin-top: auto; /* push actions to the bottom of the container */
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: center;
      width: 100%;
    }

    #profile-screen .profile-match-visual { width: 120px; height: 80px; }
    #profile-screen .recommendation-label { font-size: 1.1rem; }

    @media (max-width: 480px), (max-height: 640px) {
      #profile-screen .profile-container { min-height: calc(100vh - 100px); padding: 0.75rem 0; }
      #profile-screen .profile-match-visual { width: 96px; height: 64px; }
      #profile-screen .profile-reveal-item { margin-bottom: 0.5rem; }
      #profile-screen .recommendation-label { font-size: 1rem; }
      #profile-screen .profile-actions-group .btn, #profile-screen .profile-actions-group .btn-cta-profile { width: 92%; max-width: 360px; padding: 0.9rem 1rem; font-size: 1rem; }
    }
        .nutri-score-badge { border: 1px solid var(--border-subtle); padding: 1rem 1.2rem; text-align: center; min-width: 120px; background: rgba(0,0,0,0.2); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .nutri-score-badge .label { font-size: 0.7rem; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
        .nutri-score-badge .score { font-size: 2.5rem; font-weight: 700; line-height: 1; }
        .score-A { color: #8cc63f; } .score-B { color: #c4d82f; } .score-C { color: #f8b518; } .score-D { color: #eb842a; } .score-E { color: #e34033; }
        .card-section { background: rgba(0,0,0,0.2); padding: 1.5rem 2rem; border: 1px solid var(--border-subtle); margin-top: 2rem; }
        .section-title { margin: 0 0 1.5rem 0; font-size: 1rem; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid var(--border-subtle); padding-bottom: 1rem; font-family: 'Loyola Pro Bold', serif; }
        .section-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .description-label { display: block; margin-bottom: 0.5rem; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); font-weight: 600; }
        .nutrient-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; }
        .nutrient-card { background: rgba(0,0,0,0.2); padding: 1rem; border: 1px solid var(--border-subtle); text-align: center; }
        .nutrient-card .label { font-size: 0.65rem; color: var(--accent); font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
        .nutrient-card .value { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-top: 0.5rem; }
        


/* ========================================================== */
/* ======= BLOCS CSS POUR L'EXPANSION DES CARTES =========== */
/* ========================================================== */

/* Ensure expanded card fills available viewport area so internal content is readable */
.card.is-expanded {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  top: 72px; /* keep header visible */
  width: calc(100% - 2rem);
  max-width: 760px;
  height: calc(100vh - 96px);
  max-height: calc(100vh - 96px);
  z-index: 6000;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 30px 90px rgba(0,0,0,0.75);
}

/* media stays at top of expanded card; keep fixed area so info scrolls underneath */
.card.is-expanded .card-media {
  height: 40vh;
  min-height: 160px;
  max-height: 48vh;
  background-size: cover;
  background-position: center;
}

/* Info becomes scrollable within the expanded card */
.card.is-expanded .card-info {
  position: relative;
  overflow-y: auto;
  max-height: calc(100% - 40vh);
  /* leave extra bottom padding so a fixed CTA can sit above the edge */
  padding: 1.25rem 1.25rem 5.5rem;
}

/* Pin CTA inside expanded card so it never overlaps content and stays visible */
.card.is-expanded .card-external-link {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 18px;
  opacity: 1;
  pointer-events: auto;
  z-index: 12;
  /* ensure the animated entrance still works */
  transition: opacity 0.3s ease, transform 0.3s ease;
}

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC MODIFIÃ‰ : Titre de la carte ========= */
/* ========================================================== */

/* Collapsed: show a compact info preview (name + chevron) */
.card .card-info {
  max-height: 92px;
  overflow: hidden;
  transition: max-height 0.36s ease, padding 0.3s ease;
}
.card .card-info .card-name {
  font-size: 1.2rem; // âœ…
  font-weight: 700;
  display: block;
  white-space: normal; /* âœ… C'EST LA CORRECTION CLÃ‰ : autorise le retour Ã  la ligne */
  overflow: visible; /* âœ… On s'assure que le texte n'est pas coupÃ© */
  text-overflow: unset; /* âœ… On annule l'effet "..." */
  min-width: 0; /* âœ… EmpÃªche les mots longs de forcer la largeur du parent */
  line-height: 1.2; /* âœ… AmÃ©liore l'espacement entre les lignes du titre */
}

/* ========================================================== */
/* ========= FIN DU BLOC MODIFIÃ‰ : Titre de la carte ========= */
/* ========================================================== */

/* When the card is expanded, allow the product name to wrap on multiple lines */
.card.is-expanded .card-info .card-name {
  white-space: normal;
  overflow: visible;
  text-overflow: unset;
}

/* Chevron pulse to hint at more content when collapsed */
@keyframes chev-pulse { 0% { transform: translateY(0); opacity: 0.9; } 50% { transform: translateY(-4px); opacity: 1; } 100% { transform: translateY(0); opacity: 0.9; } }
.card:not(.is-expanded) .card-expand-chevron { animation: chev-pulse 1.1s ease-in-out infinite; stroke: #ff3b3b; color: #ff3b3b; }

@media (max-height: 640px) {
  .card.is-expanded { top: 56px; height: calc(100vh - 72px); }
  .card.is-expanded .card-media { min-height: 140px; }
  .card .card-info { max-height: 84px; }
}

/* ========================================================== */
/* ======= FIN BLOCS CSS POUR L'EXPANSION DES CARTES ========= */
/* ========================================================== */



/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Jauge de Convergence ========= */
/* ========================================================== */

.convergence-gauge-container {
    width: 100%;
    max-width: 300px;
    margin: 0 auto 0.75rem; /* âœ… Marge infÃ©rieure rÃ©duite de moitiÃ© */
    text-align: center;
}
.convergence-gauge-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}
.convergence-gauge-bar {
    width: 100%;
    height: 8px;
    background: rgba(80, 36, 28, 0.5); /* âœ… Fond de la jauge */
    border: 1px solid var(--border-subtle);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}
.convergence-gauge-fill {
    height: 100%;
    width: 0%; /* âœ… Commence Ã  0% */
    background: linear-gradient(90deg, var(--accent) 0%, var(--primary) 100%);
    box-shadow: 0 0 15px var(--glow);
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); /* âœ… Animation fluide */
    border-radius: 4px;
}
.convergence-gauge-percent {
    font-size: 1rem;
    font-weight: 700;
    color: var(--primary);
    margin-top: 0.5rem;
    font-family: 'Loyola Pro Bold', serif;
}

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : IcÃ´ne d'Aide ========= */
/* ========================================================== */

.help-icon {
    display: inline-block;
    width: 18px;
    height: 18px;
    background: var(--border-subtle);
    color: var(--text-secondary);
    border-radius: 50%;
    font-size: 13px;
    font-weight: bold;
    text-align: center;
    line-height: 18px;
    cursor: pointer;
    margin-left: 8px;
    transition: all 0.3s ease;
    user-select: none;
    font-family: serif; /* Pour un '?' plus joli */
    vertical-align: middle; /* Pour bien l'aligner avec le texte */
}
.help-icon:hover {
    background: var(--accent);
    color: var(--dark);
    transform: scale(1.1) rotate(15deg);
}

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Coach Pop-up et Animation ========= */
/* ========================================================== */

/* On s'assure que le conteneur du label peut positionner le pop-up */
.convergence-gauge-label {
    position: relative; /* âœ… Contexte de positionnement pour le pop-up */
    display: inline-block; /* âœ… S'assure que le conteneur ne prend pas toute la largeur */
}

/* Le pop-up lui-mÃªme, cachÃ© par dÃ©faut */
#coach-popup {
    position: absolute;
    /* âœ… La nouvelle position par dÃ©faut, au-dessus du label */
    top: -10px;
    left: 50%;
    right: auto;
    transform: translateX(-50%) translateY(-100%);
    background: #e34033;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-family: 'Playpen Sans', sans-serif;
    white-space: nowrap;
    box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* La petite flÃ¨che du pop-up */
#coach-popup::after {
    content: '';
    position: absolute;
    /* âœ… On rÃ©oriente la flÃ¨che pour qu'elle pointe vers le BAS */
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #e34033 transparent transparent transparent;
}

/* L'animation de pulsation */
@keyframes pulse-red {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(227, 64, 51, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(227, 64, 51, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(227, 64, 51, 0); }
}

/* La classe qui dÃ©clenche tout ! */
.convergence-gauge-label.has-hint .help-icon {
    background: #e34033; /* âœ… Devient rouge */
    color: white;
    animation: pulse-red 2s infinite; /* âœ… Lance l'animation de pulsation */
    border-color: #e34033;
}

/* Affiche le pop-up quand la classe est prÃ©sente */
.convergence-gauge-label.has-hint #coach-popup {
    opacity: 1;
    /* âœ… On s'assure que l'animation de slide-in vient du haut */
    transform: translateX(-50%) translateY(-100%) translateY(-5px);
}

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ AJOUTER : Coach Pop-up et Animation ========= */
/* ========================================================== */

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Responsive Coach Pop-up ========= */
/* ========================================================== */

@media (max-width: 500px) {
    /* Sur mobile, on donne un peu d'espace au-dessus pour que le pop-up ne soit pas collÃ© au header */
    .convergence-gauge-container {
        margin-top: 1.5rem; /* âœ… */
    }
@media (max-width: 500px) {
  /* Sur mobile, on donne un peu d'espace au-dessus pour que le pop-up ne soit pas collÃ© au header */
  .convergence-gauge-container {
    margin-top: 1.5rem; /* âœ… */
  }

  #coach-popup {
    /* On change complÃ¨tement le positionnement pour le mettre AU-DESSUS */
    top: -10px; /* âœ… Remonte le pop-up */
    left: 50%; /* âœ… Centre horizontalement par rapport au parent */
    right: auto; /* âœ… On annule la position Ã  droite */
    transform: translateX(-50%) translateY(-100%); /* âœ… Centrage horizontal parfait et le place au-dessus */
    font-size: 0.75rem; /* On le rend un peu plus petit sur mobile */
  }

  #coach-popup::after {
    /* On rÃ©oriente la flÃ¨che pour qu'elle pointe vers le BAS */
    top: 100%; /* âœ… Se place en bas du pop-up */
    left: 50%; /* âœ… Se centre horizontalement */
    margin-top: 0;
    margin-left: -5px;
    /* La magie est ici : on change la bordure qui a la couleur */
    border-color: #e34033 transparent transparent transparent; /* âœ… */
  }

  /* On s'assure que l'animation de slide-in vient du haut */
  .convergence-gauge-label.has-hint #coach-popup {
    transform: translateX(-50%) translateY(-100%) translateY(-5px); /* âœ… Position de dÃ©part */
  }
}

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ AJOUTER : Responsive Coach Pop-up ========= */
/* ========================================================== */

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Style de l'Ã‰cran de Match ========= */
/* ========================================================== */

#match-screen-overlay {
    /* âœ… On force le fond dÃ©gradÃ© pour Ã©craser le fond noir transparent de .modal-overlay */
    background: linear-gradient(160deg, var(--dark-secondary) 0%, var(--accent) 150%);
    /* âœ… On annule explicitement l'effet de flou hÃ©ritÃ© de .modal-overlay */
    backdrop-filter: none;
    z-index: 5000; /* Doit Ãªtre au-dessus de tout */
}
.match-content-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    width: 100%;
    height: 100%;
    overflow: hidden; /* EmpÃªche les pulsations de dÃ©border */
}

/* --- Animation de fond pulsante --- */
.pulse-bg {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(237, 193, 150, 0.2) 0%, rgba(237, 193, 150, 0) 70%);
    animation: pulse 4s ease-out infinite;
}
.pulse-1 { width: 300px; height: 300px; }
.pulse-2 { width: 500px; height: 500px; animation-delay: 1s; }
.pulse-3 { width: 700px; height: 700px; animation-delay: 2s; }

@keyframes pulse {
    0% { transform: scale(0.5); opacity: 0; }
    50% { opacity: 1; }
    100% { transform: scale(1.2); opacity: 0; }
}

/* --- Photos de profil --- */
.match-pfps {
    display: flex;
    position: relative;
    margin-bottom: 2rem;
    filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5));
}

.match-pfp {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    border: 5px solid var(--primary);
    background-color: var(--dark);
    background-size: cover;
    background-position: center;
    box-shadow: 0 0 40px var(--glow);
    /* Animation d'entrÃ©e */
    opacity: 0;
    transform: scale(0.5);
}

#user-match-pfp {
    transform: translateX(20px) scale(0.5);
}
#meat-match-pfp {
    transform: translateX(-20px) scale(0.5);
    margin-left: -40px; /* Chevauchement des cercles */
}

/* --- Textes --- */
.match-title {
    font-size: clamp(4rem, 15vw, 7rem);
    text-transform: uppercase;
    letter-spacing: 5px;
    color: white;
    text-shadow: 0 5px 40px rgba(0,0,0,0.6);
    margin: 0;
    line-height: 1;
    /* Animation d'entrÃ©e */
    opacity: 0;
    transform: translateY(20px);
}

.match-subtitle {
    font-family: 'Playpen Sans', sans-serif;
    font-size: 1.2rem;
    color: rgba(255, 255, 255, 0.8);
    font-style: italic;
    margin-top: 1.5rem;
    /* Animation d'entrÃ©e */
    opacity: 0;
    transform: translateY(20px);
}


/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT DES BLOCS CSS Ã€ MODIFIER/AJOUTER =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

/* --- 1. MODIFIEZ la classe .recommendation-label --- */
.recommendation-label {
    font-family: 'Loyola Pro Bold', serif;
    font-size: 1.8rem;
    color: var(--primary);
    text-transform: none;
    letter-spacing: 0;
    margin-bottom: 1.5rem;
    line-height: 1.3;
}

/* --- 2. SUPPRIMEZ l'ancienne classe .profile-cta-link --- */
/* (Supprimez complÃ¨tement les rÃ¨gles pour .profile-cta-link et .profile-cta-link:hover) */

/* --- On garde le bouton principal CTA tel quel --- */
.btn-cta-profile {
    background: var(--accent);
    color: var(--dark);
    border: none;
    padding: 1.2rem 3rem;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 30px rgba(204, 137, 86, 0.3);
    letter-spacing: 1px;
    text-transform: uppercase;
    font-family: 'Loyola Pro Bold', serif;
    display: inline-block;
    text-decoration: none;
    margin-bottom: 1.5rem;
    animation: pulse-cta 2.5s infinite; /* âœ… C'est cette ligne qui active la pulsation. */
}
.btn-cta-profile:hover {
    background: var(--primary);
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(237, 193, 150, 0.4);
    animation-play-state: paused;
}


/* --- RÃˆGLE POUR LE BOUTON "CONTINUER" --- */
#continue-swiping-btn {
    /* Style copiÃ© du bouton principal */
    background: var(--accent);
    color: var(--dark);
    border: none;
    padding: 1rem 2.5rem;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(204, 137, 86, 0.2);
    letter-spacing: 1px;
    text-transform: uppercase;
    font-family: 'Loyola Pro Bold', serif;
    
    /* Modifications spÃ©cifiques */
    margin-top: 1rem;
    /* Pas de propriÃ©tÃ© "animation" pour que ce bouton reste statique */ /* âœ… */
}
#continue-swiping-btn:hover {
    background: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(237, 193, 150, 0.3);
}
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN DES BLOCS CSS Ã€ MODIFIER/AJOUTER =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

.btn-cta-profile:hover {
    background: var(--primary);
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(237, 193, 150, 0.4);
    animation-play-state: paused; /* âœ… ArrÃªte la pulsation au survol */
}

@keyframes pulse-cta {
    0% { transform: scale(1); box-shadow: 0 8px 30px rgba(204, 137, 86, 0.3); }
    50% { transform: scale(1.05); box-shadow: 0 12px 45px rgba(204, 137, 86, 0.5); }
    100% { transform: scale(1); box-shadow: 0 8px 30px rgba(204, 137, 86, 0.3); }
}


/* --- 4. MODIFIEZ .radar-legend pour le texte --- */
.radar-legend {
    position: absolute;
    transform: translate(-50%, -50%);
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.7rem; /* Taille du texte */
    text-transform: uppercase;
    letter-spacing: 1px;
    pointer-events: none; /* EmpÃªche d'interfÃ©rer avec les clics */
}
.radar-legend .emoji {
    font-size: 1.5rem; /* Taille de l'emoji */
    display: block;
    margin-bottom: 2px;
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN DES BLOCS CSS Ã€ MODIFIER/AJOUTER =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC FINAL : CSS RESPONSIVE COMPLET ========= */
/* ========================================================== */

        @media (max-width: 768px) {
            /* === MICRO-OPTIMISATIONS === */
            .main-title {
                font-size: clamp(1.8rem, 5vw, 2.2rem);
            }
        }
            .action-btn.undo { 
                width: 44px; height: 44px; font-size: 1.1rem;
            }
            .action-btn.dislike, .action-btn.like { 
                width: 54px; height: 54px;
            }
            .action-btn.dislike { font-size: 2rem; }
            .action-btn.like { font-size: 1.8rem; }

            /* === COMPRESSION DES ESPACES === */
            .container { padding: 1.5rem; }
            .header { margin-bottom: 1.5rem; flex-direction: column; gap: 0.5rem; }
            .convergence-gauge-container { margin: 0 auto 0.75rem; }
            .actions { gap: 1rem; margin-top: 0.5rem; }

            /* === CONTRÃ”LE DE LA HAUTEUR DE LA CARTE === */
            #swipe-screen.active {
                height: 100%;
            }
            .card-deck {
                flex-grow: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 300px;
                max-height: 50vh;
            }
            .card {
                height: 100%;
                max-height: 480px;
                aspect-ratio: 10 / 14;
            }

            /* === AUTRES AJUSTEMENTS MOBILES === */
            .welcome-title { font-size: 2.5rem; }
            .welcome-description { font-size: 1rem; }
            .btn-welcome { padding: 1.2rem 2rem; font-size: 1rem; }
            .profile-header { flex-direction: column; text-align: center; }
        }

        @media (max-width: 640px) { 
            .card-sensor-bars { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 10px 16px; 
                height: auto; 
                padding: 10px 12px; 
            } 
            .thermo-bar-row { 
                width: 95%; 
            } 
        }

/* ========================================================== */
/* ========= FIN DU BLOC FINAL : CSS RESPONSIVE COMPLET ========= */
/* ========================================================== */

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Style du Bouton Match ========= */
/* ========================================================== */

.btn-match-profile {
    margin-top: 3rem;
    padding: 1.2rem 2.5rem;
    background: var(--primary);
    color: var(--dark-secondary);
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    transition: all 0.3s ease;

    /* Animation d'entrÃ©e */
    opacity: 0;
    transform: translateY(20px);
}
.btn-match-profile:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 15px 50px rgba(0,0,0,0.6);
}

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ AJOUTER : Style du Bouton Match ========= */
/* ========================================================== */
/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Style du Bouton "Continuer" ========= */
/* ========================================================== */

#continue-swiping-btn-match {
    margin-top: 1rem;
    background: transparent;
    border: 1px solid var(--border-subtle);
    color: var(--text-light);
    font-size: 1rem;
    padding: 1rem 2.5rem;
    box-shadow: none;
}
#continue-swiping-btn-match:hover {
    background: rgba(237, 193, 150, 0.1);
    border-color: var(--accent);
    transform: translateY(-2px);
}

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ AJOUTER : Style du Bouton "Continuer" ========= */
/* ========================================================== */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT BLOC WOW : ANIMATIONS Ã‰CRAN PROFIL =-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

/* --- Animation gÃ©nÃ©rale pour les Ã©lÃ©ments de texte --- */
@keyframes reveal-up {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* --- Classe utilitaire pour les Ã©lÃ©ments qui apparaissent --- */
.profile-reveal-item {
    opacity: 0; /* Commence cachÃ© */
    animation: reveal-up 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
}

/* --- Animation spÃ©cifique pour le graphique radar --- */
#profile-radar-final .radar-bg {
    opacity: 0;
    animation: reveal-up 0.5s ease-out 0.8s forwards; /* Le fond apparaÃ®t en premier */
}

#profile-radar-final .radar-shape {
    transform-origin: center;
    transform: scale(0); /* Le polygone commence tout petit au centre */
    animation: grow-shape 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) 1.2s forwards; /* Il grandit avec un effet "ressort" */
}

@keyframes grow-shape {
    from { transform: scale(0); }
    to { transform: scale(1); }
}

/* --- Animation de pulsation pour le graphique une fois dessinÃ© --- */
#profile-radar-final .radar-shape {
    /* On ajoute une deuxiÃ¨me animation pour le faire pulser aprÃ¨s coup */
    animation: grow-shape 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) 1.2s forwards, 
               pulse-glow 3s ease-in-out 2.5s infinite; /* âœ… */
}

@keyframes pulse-glow {
    0%, 100% {
        filter: drop-shadow(0 0 5px var(--glow));
    }
    50% {
        filter: drop-shadow(0 0 15px var(--primary));
    }
}

/* --- Animation pour les lÃ©gendes du radar --- */
.radar-legend {
    opacity: 0;
    animation: reveal-up 0.6s ease-out 1.5s forwards; /* Apparaissent aprÃ¨s le dessin du graphique */
}


/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN BLOC WOW : ANIMATIONS Ã‰CRAN PROFIL =-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- DÃ‰BUT BLOC CORRECTION : LÃ‰GENDES RADAR =-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

/* On retire l'ancienne transformation gÃ©nÃ©rique */
.radar-legend {
    transform: none !important; /* âœ… Annule les anciens calculs pour laisser place aux nouvelles rÃ¨gles */
}

/* Nouvelles rÃ¨gles de positionnement spÃ©cifiques pour chaque coin */
.legend-top {
    top: -15%;
    left: 42%;
    transform: translate(-50%, calc(-100% - 5px)); /* âœ… Aligne par le bas et ajoute 5px de marge */
}

.legend-right {
    top: 30%;
    left: 90%;
    transform: translate(12px, -50%); /* âœ… Aligne par la gauche et ajoute 12px de marge */
}

.legend-bottom {
    bottom: -9%;
    left: 35%;
    transform: translate(-50%, calc(100% + 5px)); /* âœ… Aligne par le haut et ajoute 5px de marge */
}

.legend-left {
    top: 30%;
    left: -18%;
    transform: translate(calc(-100% - 12px), -50%); /* âœ… Aligne par la droite et ajoute 12px de marge */
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=-=- FIN BLOC CORRECTION : LÃ‰GENDES RADAR =-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Galerie des Matchs ========= */
/* ========================================================== */

#results-screen {
    text-align: center;
    display: flex;
    flex-direction: column;
}

#results-screen h1 {
    margin-bottom: 0.5rem;
}

#results-screen .results-subtitle {
    color: var(--text-secondary);
    font-style: italic;
    margin-bottom: 3rem;
}

#matches-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-width: 700px;
    width: 100%;
    align-self: center; /* Pour centrer la liste */
}

.match-gallery-item {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    background: rgba(80, 36, 28, 0.2);
    border: 1px solid var(--border-subtle);
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    text-align: left;
    opacity: 0; /* Pour l'animation d'entrÃ©e */
    transform: translateX(-30px); /* Pour l'animation d'entrÃ©e */
    animation: slideInFromLeft 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards;
    animation-delay: var(--delay, 0s);
}

@keyframes slideInFromLeft {
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.match-gallery-pfps {
    position: relative;
    width: 120px;
    height: 80px;
    flex-shrink: 0;
}

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC MODIFIÃ‰ : Superposition des images (RÃ©sultats) ========= */
/* ========================================================== */

.match-gallery-pfps .user-pfp,
.match-gallery-pfps .product-pfp {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid var(--primary);
    background-size: cover;
    background-position: center;
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    position: absolute;
    top: 0;
}

.match-gallery-pfps .user-pfp {
    left: 0;
    z-index: 1; /* âœ… Le logo passe en arriÃ¨re-plan */
}

.match-gallery-pfps .product-pfp {
    left: 40px; /* DÃ©cale pour crÃ©er le chevauchement */
    z-index: 2; /* âœ… L'image du produit passe au premier plan */
}

/* ========================================================== */
/* ========= FIN DU BLOC MODIFIÃ‰ : Superposition des images (RÃ©sultats) ========= */
/* ========================================================== */

.match-gallery-info {
    flex-grow: 1;
}

.match-gallery-info h3 {
    font-family: 'Loyola Pro Bold', serif;
    font-size: 1.6rem;
    margin: 0 0 0.5rem;
    color: var(--primary);
}

.match-gallery-info .match-compatibility {
    font-size: 0.9rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 1rem;
}

.btn-view-product {
    font-family: 'Playpen Sans', sans-serif;
    font-size: 0.9rem;
    padding: 0.6rem 1rem;
    border: 1px solid var(--border-subtle);
    background: transparent;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-view-product:hover {
    border-color: var(--accent);
    background: rgba(204, 137, 86, 0.2);
    transform: translateY(-2px);
}

.no-matches-message {
    font-size: 1.2rem;
    color: var(--text-secondary);
    font-style: italic;
    min-height: 40vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.results-actions {
    margin-top: auto; /* Pousse les boutons en bas */
    padding-top: 2rem;
}
/* ========================================================== */
/* ========= FIN DU BLOC Ã€ AJOUTER : Galerie des Matchs ========= */
/* ========================================================== */

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Visuel Match Profil (v2) ========= */
/* ========================================================== */

.profile-match-visual {
    display: flex; /* âœ… On utilise flex pour le positionnement */
    justify-content: center; /* âœ… Centrage horizontal */
    position: relative;
    margin: 0 auto 2rem; /* Centre l'Ã©lÃ©ment et ajoute une marge en dessous */
    filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5));
    width: 150px; /* Largeur totale de l'ensemble */
    height: 100px; /* Hauteur totale */
}

.profile-match-visual .profile-match-logo,
.profile-match-visual .profile-match-meat {
    width: 100px; /* âœ… Taille rÃ©duite des cercles */
    height: 100px; /* âœ… Taille rÃ©duite des cercles */
    border-radius: 50%;
    border: 3px solid var(--primary); /* âœ… Bordure plus fine */
    background-size: cover;
    background-position: center;
    box-shadow: 0 0 25px var(--glow); /* âœ… Ombre plus subtile */
    position: absolute;
    top: 0;
}

.profile-match-visual .profile-match-logo {
    transform: translateX(-20px); /* âœ… DÃ©cale le logo Ã  gauche */
    z-index: 1;
    background-color: var(--dark);
}

.profile-match-visual .profile-match-meat {
    transform: translateX(62px); /* âœ… DÃ©cale le morceau Ã  droite */
    z-index: 2; /* âœ… Assure que le morceau passe devant */
}

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ AJOUTER : Visuel Match Profil (v2) ========= */
/* ========================================================== */

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC MODIFIÃ‰ : Style du bouton "Mes SMASHS" ========= */
/* ========================================================== */

#view-matches-btn {
    display: none; /* Toujours contrÃ´lÃ© par JS */
    background: rgba(237, 193, 150, 0.05); /* âœ… Fond identique aux icÃ´nes */
    border: 1px solid var(--border-subtle); /* âœ… Bordure identique aux icÃ´nes */
    color: var(--text-secondary); /* âœ… Couleur identique aux icÃ´nes */
    height: 38px; /* âœ… Hauteur lÃ©gÃ¨rement rÃ©duite pour l'esthÃ©tique */
    padding: 0 1.2rem; /* âœ… Padding horizontal pour que la boÃ®te s'adapte au texte */
    font-size: 0.8rem; /* âœ… Texte plus petit et plus fin */
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: 'Loyola Pro Bold', serif;
    /* On retire les anciennes propriÃ©tÃ©s non nÃ©cessaires */
}
#view-matches-btn:hover {
    border-color: var(--accent); /* âœ… Effet de survol identique */
    background: rgba(204, 137, 86, 0.15);
    transform: translateY(-2px);
    color: var(--primary);
}

/* ========================================================== */
/* ========= FIN DU BLOC MODIFIÃ‰ : Style du bouton "Mes SMASHS" ========= */
/* ========================================================== */

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Bouton "Voir Mon Profil" (RÃ©sultats) ========= */
/* ========================================================== */

#view-profile-from-results-btn {
    background: transparent;
    border: 1px solid var(--border-subtle);
    color: var(--text-light);
    padding: 0.8rem 1.5rem;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: 'Loyola Pro Bold', serif;
    margin-bottom: 2.5rem; /* Espace avant le titre "Tes smashs" */
}

#view-profile-from-results-btn:hover {
    border-color: var(--accent);
    background: rgba(204, 137, 86, 0.15);
    transform: translateY(-2px);
    color: var(--primary);
}

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ AJOUTER : Bouton "Voir Mon Profil" (RÃ©sultats) ========= */
/* ========================================================== */

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Style du Pop-up Produit ========= */
/* ========================================================== */

#product-modal-overlay .modal-close-btn {
    position: absolute; /* âœ… Positionnement flottant */
    top: 1rem; /* âœ… En haut */
    right: 1rem; /* âœ… Ã€ droite */
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10; /* âœ… S'assure qu'il est au-dessus du contenu */
}
#product-modal-overlay .modal-close-btn:hover {
    color: var(--primary);
    transform: rotate(90deg);
}

/* On s'assure que le contenu du modal est bien centrÃ© */
#product-modal-overlay .product-modal-content {
    text-align: center;
}

/* On centre le titre du produit */
#product-modal-overlay .product-modal-title {
    margin-top: 1.5rem;
}

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ AJOUTER : Style du Pop-up Produit ========= */
/* ========================================================== */


    </style>
</head>
<body>

<!-- ========================================================== -->
<!-- ============== BLOC 2 : STRUCTURE HTML COMPLET =========== -->
<!-- ========================================================== -->

<div id="welcome-screen" class="view-container">
    <div class="welcome-content">
        <div class="welcome-logo"><img src="https://raw.githubusercontent.com/metscarnes/bimi-metscarnes/main/Logo%20Mets%20Carn%C3%A9s%20HD.png" alt="Logo"></div>
        <h1 class="welcome-title">SMASH ðŸ”¥</h1>
        <p class="welcome-description">DÃ©couvre ton morceau idÃ©al.<br>Swipez, smatshez, dÃ©gustez.</p>
        <button id="start-btn" class="btn btn-welcome">ðŸ”¥ Trouver mon smatch</button>
    </div>
</div>

<div id="app" class="view-container">
    <div class="container">
<header class="header">
            <div class="header-actions">
                <button id="back-btn" class="btn-icon" title="Retour" style="display: none;">â¬…ï¸</button>
                <button id="reset-btn" class="btn-icon" title="Recommencer">ðŸ”„</button>
            </div>
            <div class="main-title-wrapper">
                <h1 class="main-title">SMASHS ðŸ”¥</h1>
                <p class="subtitle">Ta Rencontre Charnelle</p>
<button id="view-matches-btn" style="display: none;">ðŸ† MES SMASHS</button>
            </div>
        </header>
        <main id="screen-root">
            <div id="intro-wrapper" class="screen"></div>
            <div id="question-flow" class="screen"></div>
            <div id="swipe-screen" class="screen"></div>
            <div id="results-screen" class="screen"></div>
            <!-- L'Ã©cran de profil sera ajoutÃ© ici par le JS -->
        </main>
    </div>
</div>

<div id="loading-screen" class="view-container">
    <div class="loading-content">
        <div class="loading-phase-1">
            <p class="loading-text"></p> <!-- âœ… Le texte est retirÃ©, le JS s'en occupera entiÃ¨rement -->
            <div class="loading-bar-container"><div class="loading-bar"></div></div>
        </div>
        <div class="loading-phase-2">
            <button id="reveal-btn" class="reveal-button">DÃ©couvrir les matchs</button>
        </div>
    </div>
</div>



<!-- ========================================================== -->
<!-- ========== DÃ‰BUT DU BLOC Ã€ AJOUTER : Ã‰cran de Match ========== -->
<!-- ========================================================== -->

<div id="match-screen-overlay" class="modal-overlay">
    <div class="match-content-wrapper">
        <div class="pulse-bg pulse-1"></div>
        <div class="pulse-bg pulse-2"></div>
        <div class="pulse-bg pulse-3"></div>

        <div class="match-pfps">
            <div id="user-match-pfp" class="match-pfp"></div>
            <div id="meat-match-pfp" class="match-pfp"></div>
        </div>
        
        <h1 class="match-title">Match !</h1>
        <p id="match-subtitle" class="match-subtitle"></p>

        <!-- âœ… BOUTON AJOUTÃ‰ CI-DESSOUS -->
        <button id="view-profile-btn" class="btn btn-match-profile">DÃ©couvrir mon profil</button>
<!-- âœ… BOUTON AJOUTÃ‰ CI-DESSOUS -->
<button id="continue-swiping-btn-match" class="btn">Continuer Ã  Swiper</button>
    </div>
</div>

<!-- ========================================================== -->
<!-- =========== FIN DU BLOC Ã€ REMPLACER : Ã‰cran de Match =========== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- =========== FIN DU BLOC Ã€ AJOUTER : Ã‰cran de Match =========== -->
<!-- ========================================================== -->





<!-- âœ… MODAL PRODUIT POUR AFFICHER LES DÃ‰TAILS -->
<div class="modal-overlay" id="product-modal-overlay">
  <div class="modal-content product-modal-content">
    <button class="modal-close-btn" id="product-modal-close">âœ•</button>
    <div class="product-modal-header">
      <h2 class="product-modal-title" id="product-modal-title"></h2>
      <p class="product-modal-category" id="product-modal-category"></p>
    </div>
    <div class="product-modal-body" id="product-modal-body"></div>
    <div class="product-modal-footer">
      <a href="#" class="btn btn-primary product-modal-cta" id="product-modal-cta">
        Votre date t'attend ici ðŸ’•
      </a>
    </div>
  </div>
</div>


<!-- âœ… MODAL D'ALERTE GLOBAL -->
<div class="modal-overlay" id="alert-modal">
  <div class="modal-content" style="background:#1a1614;color:#F5F1E8;padding:1.5rem;border-radius:8px;max-width:400px;margin:auto;text-align:center;">
    <h2 id="alert-modal-title"></h2>
    <p id="alert-modal-text" style="margin-top:1rem;margin-bottom:1.5rem;"></p>
    <div id="alert-modal-buttons"></div>
  </div>
</div>

<!-- ========================================================== -->
<!-- =========== BLOC 3 : SCRIPT JAVASCRIPT COMPLET =========== -->
<!-- ========================================================== -->
<script>
/* ============================================================ */
/* ðŸ§­ MODE DEBUG NARRATIF M.E.T.S                                */
/* ============================================================ */
// let DEBUG_MODE = true; // âœ… Ligne supprimÃ©e, le debug est maintenant conditionnel


document.addEventListener('DOMContentLoaded', () => {
(function() {

    const state = {
        user: { nom: "", genre: "", city: "", styleNarratif: "neutre" },
        userAnswers: {},
        profile: { Destination: undefined, Tendrete: 5, Gout: 5, Jutosite: 5, Persillage: 5, interdits: null },
        deck: [],
        matches: [],
        convergenceMatches: [],
        swipedProductNames: new Set(),
        lastSwipedCard: null,
        currentStep: 0,
        consecutiveNameErrors: 0, 
        profileHistory: [], 
        currentScreen: null,
        loggedProducts: new Set(),
        isAnimating: false,
        swipeHistory: [],
        lastHintPresented: null,
        hasNewHint: false,
    };

const DOM = {
        views: { welcome: document.getElementById('welcome-screen'), app: document.getElementById('app'), loading: document.getElementById('loading-screen') },
        appScreens: { 
            intro: document.getElementById('intro-wrapper'), 
            questions: document.getElementById('question-flow'), 
            swipe: document.getElementById('swipe-screen'), 
            results: document.getElementById('results-screen'),
            profile: null
        },
        buttons: { start: document.getElementById('start-btn'), reveal: document.getElementById('reveal-btn'), reset: document.getElementById('reset-btn'), home: document.getElementById('home-btn') },
        modals: { 
    alert: document.getElementById('alert-modal'),
            alertTitle: document.getElementById('alert-modal-title'), // âœ… AjoutÃ©
            alertText: document.getElementById('alert-modal-text'),   // âœ… AjoutÃ©
            alertButtons: document.getElementById('alert-modal-buttons'), // âœ… AjoutÃ©
            product: document.getElementById('product-modal-overlay') 
        },
        loadingBar: document.querySelector('.loading-bar'),
    };

// âœ… CORRECTION : 227 avec url
    const ALL_PRODUCTS = [ ];


// ==========================================================
// ============ BLOC DE FONCTIONS D'AFFICHAGE RESTAURÃ‰ES ET CORRIGÃ‰ES ============
// ==========================================================

function showView(v) { 
    Object.values(DOM.views).forEach(e => e.classList.remove('is-visible')); 
    if (v && DOM.views[v]) DOM.views[v].classList.add('is-visible'); 
}

function showAppScreen(s) {
    state.currentScreen = s;
    Object.values(DOM.appScreens).forEach(e => { if (e) {e.classList.remove('active'); e.style.display = 'none';} });
    
    const backBtn = document.getElementById('back-btn');
    if (backBtn) {
        backBtn.style.display = (s === 'questions' || s === 'swipe' || s === 'profile' || s === 'results') ? 'flex' : 'none';
    }

    if (s && DOM.appScreens[s]) {
        const t = DOM.appScreens[s];
        t.style.display = ['swipe', 'intro', 'questions', 'profile', 'results'].includes(s) ? 'flex' : 'block';
        t.classList.add('active');
    }
const viewMatchesBtn = document.getElementById('view-matches-btn'); // âœ… Nouvelle logique centralisÃ©e
    if (viewMatchesBtn) {
        const shouldShow = (s === 'swipe' && state.convergenceMatches.length > 0);
        viewMatchesBtn.style.display = shouldShow ? 'block' : 'none';
    }
}

function renderSwipe() {
    DOM.appScreens.swipe.innerHTML = `
        <button id="view-matches-btn" style="display: none;">ðŸ† MES SMASHS</button>
        <div class="convergence-gauge-container">
            <div class="convergence-gauge-label">
                Affinement du profil
                <span id="convergence-help-btn" class="help-icon" title="Comment Ã§a marche ?">?</span>
                <span id="coach-popup">votre coach a des astuces pour vous ! âž”</span>
            </div>
            <div class="convergence-gauge-bar">
                <div class="convergence-gauge-fill" id="convergence-fill"></div>
            </div>
            <div class="convergence-gauge-percent" id="convergence-percent">0%</div>
        </div>
        
        <div class="card-deck" id="card-deck"></div>
        <div class="actions">
            <button class="action-btn undo" id="undo-btn">â†©ï¸</button>
            <button class="action-btn dislike" id="dislike-btn">âŒ</button>
            <button class="action-btn like" id="like-btn">â¤ï¸</button>
        </div>`; // âœ… La div #feedback-toast a Ã©tÃ© supprimÃ©e ici.
    
    bindSwipeEvents(); 
    
    document.getElementById('convergence-help-btn').addEventListener('click', () => {
        const hint = generateConvergenceHint();
        showCustomAlert(hint);
        state.hasNewHint = false;
        state.lastHintPresented = hint.text;
        updateConvergenceGauge();
    });

    state.profileHistory = [];
    state.lastSwipedCard = null;
    if (state.deck.length === 0) {
        refreshDeck();
    }
    addNextCardToDeckIfNeeded();
    addNextCardToDeckIfNeeded();
    updateCardStates();
    updateConvergenceGauge();
}

/* ========================================================== */
/* ========= FIN DU BLOC MODIFIÃ‰ : renderSwipe ========= */
/* ========================================================== */

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT BLOC MODIFIÃ‰ : transitionToLoading (avec Timeline) =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

function transitionToLoading() {
    showView('loading');
    const loadingTextEl = document.querySelector('.loading-text');
    
    // --- Configuration de l'animation ---
    const PHRASE_DURATION = 1500; // âœ… Chaque phrase est visible pendant 1.5s
    const FADE_DURATION = 400;   // âœ… DurÃ©e du fondu en entrÃ©e/sortie
    const totalDuration = LOADING_MESSAGES.length * PHRASE_DURATION;

    // On s'assure que le texte est invisible au dÃ©part
    loadingTextEl.style.opacity = 0;

    // --- CrÃ©ation de la Timeline principale ---
    const tl = anime.timeline({
        duration: totalDuration,
        easing: 'linear',
        // Ã€ la toute fin de la timeline, on passe Ã  l'Ã©cran de swipe
        complete: () => {
            DOM.views.loading.classList.add('is-opening');
            setTimeout(() => {
                showView('app');
                showAppScreen('swipe');
                renderSwipe();
                DOM.views.loading.classList.remove('is-opening');
            }, 1000);
        }
    });

    // --- Animation de la barre de chargement ---
    tl.add({
        targets: DOM.loadingBar,
        width: '100%',
    }, 0); // Commence au tout dÃ©but (offset 0)

    // --- Animation sÃ©quentielle des phrases ---
    LOADING_MESSAGES.forEach((message, index) => {
        const startTime = index * PHRASE_DURATION;

        tl.add({
            targets: loadingTextEl,
            opacity: [0, 1],
            translateY: [10, 0],
            duration: FADE_DURATION,
            easing: 'easeOutQuad',
            // Juste avant que l'animation commence, on met Ã  jour le texte
            begin: () => {
                loadingTextEl.textContent = message;
            }
        }, startTime); // Chaque animation de fondu en entrÃ©e commence Ã  son propre top dÃ©part

        tl.add({
            targets: loadingTextEl,
            opacity: [1, 0],
            translateY: [0, -10],
            duration: FADE_DURATION,
            easing: 'easeInQuad',
        }, startTime + PHRASE_DURATION - FADE_DURATION); // Le fondu de sortie commence juste avant la fin de la durÃ©e de la phrase
    });
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN BLOC MODIFIÃ‰ : transitionToLoading (avec Timeline) =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */


    const NUTRITIONAL_INFO_MAP = [ { key: 'Energie', label: 'Ã‰nergie', unit: 'kcal' }, { key: 'Proteines', label: 'ProtÃ©ines', unit: 'g' }, { key: 'Lipides', label: 'Lipides', unit: 'g' }, { key: 'Glucides', label: 'Glucides', unit: 'g' }, { key: 'Sel', label: 'Sel', unit: 'g' }, { key: 'Fer', label: 'Fer', unit: 'mg' }, { key: 'Zinc', label: 'Zinc', unit: 'mg' }, { key: 'Selenium', label: 'SÃ©lÃ©nium', unit: 'Âµg' }, { key: 'VitamineB12',label: 'Vitamine B12', unit: 'Âµg' } ];
    





/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC MODIFIÃ‰ : MATCH_PHRASES ========= */
/* ========================================================== */

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT BLOC MODIFIÃ‰ : MATCH_PHRASES (v2) =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

const MATCH_PHRASES = [
    "Apparemment, {prenom}, tous tes choix de vie t'ont menÃ©{e_accord} inexorablement vers {produit_avec_article}. Ã‰tonnant. ðŸ¤·", // âœ… Utilisation de {e_accord}
    "C'est actÃ©. {produit_avec_article} et toi {prenom}, c'est plus crÃ©dible que ton dernier crush Tinder.",
    "FÃ©licitations, {prenom}. T'as trouvÃ© ta moitiÃ©... pour le dÃ®ner. C'est dÃ©jÃ  Ã§a de pris. ðŸ˜‰",
    "On dirait bien que {produit_avec_article} est le seul morceau qui supporte ton mordant. Profites-en, {prenom}. ðŸ˜œ",
    "C'est un match ! {prenom}, t'as ENFIN quelqu'un Ã  prÃ©senter Ã  tes parents : {produit_avec_article}. ðŸ™",
    "Certains trouvent l'amour. Toi {prenom}, t'as trouvÃ© {produit_avec_article}. Bon, c'est dÃ©jÃ  Ã§a. ðŸ¥²",
    "VoilÃ , {prenom}. Ta quÃªte de sens s'arrÃªte ici. Sur un lit {produit_de}. Pas mal non ? C'est FranÃ§ais ? ðŸ˜",
    "Certains trouvent l'Ã¢me sÅ“ur. Toi, {prenom}, t'as trouvÃ© {produit_avec_article}. Chacun ses prioritÃ©s. ðŸŽ¯",
    "AprÃ¨s une analyse psychologique poussÃ©e, il s'avÃ¨re que t'avais juste besoin {produit_de} dans ta vie, {prenom}. ðŸ¤“",
    "C'est officiel ! {prenom} et {produit_avec_article}, c'est une love story. Enfin, pour 20 minutes. ðŸ¥³",
    "De rien hein, {prenom}. On t'a juste trouvÃ© le seul plat capable de te faire plaisir : {produit_avec_article}. Facile. ðŸ’…",
    "Finalement, {prenom}, tout ce temps passÃ© Ã  swiper n'aura pas Ã©tÃ© vain. Tu repars avec {produit_avec_article}. ðŸ†",
    "Eh bien {prenom}, {produit_avec_article} a craquÃ© pour ton charme. Ou ta CB. SÃ»rement ta CB. ðŸ˜",
    "Le verdict est tombÃ© : t'es coupable d'avoir un match parfait avec {produit_avec_article}. ðŸ˜‹",
    "ArrÃªte de chercher, {prenom}. Ce soir, c'est {produit_avec_article} et demain... on verra ðŸ˜‰ (Je suis fatiguÃ© patron)."
];

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN BLOC MODIFIÃ‰ : MATCH_PHRASES (v2) =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

const PROFILE_PUNCHLINES = [
    "En rÃ©sumÃ© : t'as des goÃ»ts ... suspects . Mais au moins t'assumes.",
    "Conclusion : Ton palais sait ce qu'il veut, et il n'est pas du genre Ã  faire des compromis.",
    "En gros : t'assumes tes choix douteux. Et franchement, on respecte l'audace.",
    "Pour faire simple : si Ã§a ne se mange pas saignant, Ã§a ne vous intÃ©resse probablement pas.",
    "En bref : vous Ãªtes un{e} puriste. Le genre de personne qui ne met pas de glaÃ§ons dans un bon vin."
];
    const QUESTION_STEPS = [
        { id: "intention", label: "1/6", text: "Ce soir, on part sur quoi ?", helper: "Un coup de foudre gustatif ou une histoire Ã  mijoter ?", icons: ["âš¡", "ðŸ²", "ðŸ˜"], options: [{ txt: "Coup de foudre", set: { Destination: "A griller" } }, { txt: "Mijotage lent", set: { Destination: "A mijoter" } }, { txt: "Surprends-moi", set: { Destination: null } }] },
        { id: "energie", label: "2/6", text: "Quelle est ton Ã©nergie du moment ?", helper: "PlutÃ´t feu de grill ou cocon tranquille ce soir ?", icons: ["ðŸ”¥", "ðŸŒ™", "ðŸ˜‹"], options: [{ txt: "Feu de grill", apply: () => { state.profile.Gout += 2; state.profile.Jutosite += 1; } }, { txt: "Douceur du soir", apply: () => { state.profile.Tendrete += 2; state.profile.Jutosite += 1; } }, { txt: "Juste faim", apply: () => { state.profile.Gout += 1; } }] },
        { id: "rapport", label: "3/6", text: "PlutÃ´t direct ou tout en douceur ?", helper: "Tu aimes les morceaux francs ou ceux qui demandent de l'attention ?", icons: ["ðŸ¥©", "ðŸ–", "ðŸŒ¤ï¸"], options: [{ txt: "Franc et direct", apply: () => { state.profile.Tendrete = Math.max(4, state.profile.Tendrete); state.profile.Persillage = Math.max(4, state.profile.Persillage); } }, { txt: "Fondant et patient", apply: () => { state.profile.Tendrete = Math.max(7, state.profile.Tendrete); } }, { txt: "Selon l'humeur", apply: () => {} }] },
        { id: "exploration", label: "4/6", text: "Voyage ou terroir ?", helper: "On reste dans les classiques ou on se laisse tenter par l'exotisme ?", icons: ["ðŸ‡«ðŸ‡·", "ðŸŒ", "ðŸ‘€"], options: [{ txt: "Classiques", set: { ouvertureExotique: false } }, { txt: "Curieux", set: { ouvertureExotique: true } }, { txt: "Les deux", set: { ouvertureExotique: "mixte" } }] },
        { id: "partage", label: "5/6", text: "Pour toi... ou pour partager ?", helper: "Tu partages, ou tu gardes tout pour toi ? ðŸ˜", icons: ["ðŸ’ž", "ðŸ˜‹", "ðŸ˜‡"], options: [{ txt: "Je partage", set: { partage: "partage" } }, { txt: "Je garde", set: { partage: "garde" } }, { txt: "Ã‡a dÃ©pend", set: { partage: "depend" } }] },
        { id: "interdits", label: "6/6", text: "Avant que je fasse une boulette...", helper: "Des viandes que tu ne veux pas voir ?", type: "multi" }
    ];
    const ESPECES = [ { name: "Aucune restriction", emoji: "ðŸ˜‹" },{ name: "Porc", emoji: "ðŸ·" }, { name: "Cheval", emoji: "ðŸŽ" }, { name: "Viande exotique", emoji: "ðŸŠ" }, { name: "Gibier", emoji: "ðŸ¦Œ" }, { name: "Agneau", emoji: "ðŸ‘" }, { name: "BÅ“uf", emoji: "ðŸ„" }, { name: "Veau", emoji: "ðŸ®" }, { name: "Volaille", emoji: "ðŸ”" } ];
/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ AJOUTER : Fonctions d'Articles ========= */
/* ========================================================== */

function getArticleForProduit(produitBrut) {
    if (!produitBrut) return "";
    const p = produitBrut.trim();
    const lower = p.toLowerCase();
    const voyelles = "aÃ Ã¢Ã¤eÃ©Ã¨ÃªÃ«iÃ¯Ã®oÃ´Ã¶uÃ¹Ã»Ã¼yh";
    if (voyelles.includes(lower[0])) return "lâ€™";
    const femCandidats = ["aiguillette", "araignÃ©e", "bavette", "cÃ´te", "cote", "poitrine", "Ã©paule", "selle", "viande"];
    if (femCandidats.some(f => lower.startsWith(f))) return "la";
    return "le";
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT BLOC MODIFIÃ‰ : Contraction (v5 - Logique finale) =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

function formatProduitContractionDe(produitBrut) {
    if (!produitBrut) return "";
    const p = produitBrut.trim().toLowerCase();
    
    // âœ… Nouvelle logique beaucoup plus robuste
    
    // Cas 1 : Le nom est dÃ©jÃ  composÃ© (ex: "joue de boeuf"). On ne touche Ã  rien.
    if (p.includes(" de ") || p.includes(" d'")) {
        return `de ${p}`;
    }

    // Cas 2 : Le nom commence par une voyelle (ex: "osso bucco"). On utilise "d'".
    const voyelles = "aÃ Ã¢Ã¤eÃ©Ã¨ÃªÃ«iÃ¯Ã®oÃ´Ã¶uÃ¹Ã»Ã¼yh";
    if (voyelles.includes(p[0])) {
        return `dâ€™${p}`;
    }

    // Cas 3 : Le nom est simple et ne commence pas par une voyelle.
    // On utilise la fonction d'article pour dÃ©terminer si c'est "du" ou "de la".
    const articleComplet = formatProduitAvecArticle(produitBrut).split(' ')[0];
    
    if (articleComplet === 'le') return `du ${p}`;
    if (articleComplet === 'la') return `de la ${p}`;
    
    // Cas par dÃ©faut (ne devrait quasiment jamais arriver)
    return `de ${p}`;
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN BLOC MODIFIÃ‰ : Contraction (v5 - Logique finale) =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ AJOUTER : Fonctions d'Articles ========= */
/* ========================================================== */
    const LOADING_MESSAGES = 
["Le gras c'est la vie", 
"On analyse tes choix de vie", 
"Je suis fatiguÃ© patron"];

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT BLOC Ã€ AJOUTER : RÃ©intÃ©gration de formatProduitPourLieu =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

function formatProduitPourLieu(produitBrut) {
    if (!produitBrut) return "";
    const p = produitBrut.trim().toLowerCase();
    const voyelles = "aÃ Ã¢Ã¤eÃ©Ã¨ÃªÃ«iÃ¯Ã®oÃ´Ã¶uÃ¹Ã»Ã¼yh";

    // âœ… GÃ¨re le 'h' aspirÃ© pour Ã©viter "d'haut de cuisse"
    if (p.startsWith('haut')) {
        return `de ${p}`;
    }

    if (voyelles.includes(p[0])) {
        return `dâ€™${p}`;
    }
    return `de ${p}`;
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN BLOC Ã€ AJOUTER : RÃ©intÃ©gration de formatProduitPourLieu =-=-=-=-=-=- */

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT BLOC MODIFIÃ‰ : Grammaire BasÃ©e sur les DonnÃ©es =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

function formatProduitAvecArticle(product) { // âœ… Accepte l'objet produit entier
      if (!product || !product.Produit) return "";
      const p = product.Produit.trim();
      const lower = p.toLowerCase();
      
      if (lower.startsWith('haut')) {
          return "le " + lower;
      }

      const voyelles = "aÃ Ã¢Ã¤eÃ©Ã¨ÃªÃ«iÃ¯Ã®oÃ´Ã¶uÃ¹Ã»Ã¼yh";
      if (voyelles.includes(lower[0])) return "lâ€™" + lower;
      
      // âœ… La logique se base maintenant sur product.Genre, la liste femCandidats est supprimÃ©e.
      if (product.Genre && product.Genre.toLowerCase() === 'fÃ©minin') {
          return "la " + lower;
      }
      
      return "le " + lower;
}

function formatProduitContractionDe(product) { // âœ… Accepte l'objet produit entier
    if (!product || !product.Produit) return "";
    const p = product.Produit.trim().toLowerCase();
    
    const voyelles = "aÃ Ã¢Ã¤eÃ©Ã¨ÃªÃ«iÃ¯Ã®oÃ´Ã¶uÃ¹Ã»Ã¼yh";
    if (voyelles.includes(p[0])) {
        return `dâ€™${p}`;
    }

    if (p.includes(" de ") || p.includes(" d'")) {
        return `de ${p}`;
    }

    // âœ… La logique se base maintenant sur product.Genre.
    if (product.Genre && product.Genre.toLowerCase() === 'fÃ©minin') {
        return `de la ${p}`;
    }
    
    return `du ${p}`;
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN BLOC MODIFIÃ‰ : Grammaire BasÃ©e sur les DonnÃ©es =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
function formatText(template, data) {
    if (!template) return "";
    let result = template;
    for (const key in data) {
        const regex = new RegExp(`\\{${key}\\}`, 'g');
        result = result.replace(regex, data[key]);
    }
    return result;
}

    const memory = { lastPhrase: "", lastActions: [], lastIntro: "", lastSujet: "", lastVerbe: "", lastCompl: "", lastPonct: "" };
    const GABARITS = {
        intros: {
            like: {
                exploration: ["IntÃ©ressant. PremiÃ¨re donnÃ©e pertinente enregistrÃ©e", "OK, un premier point de donnÃ©es. On verra oÃ¹ Ã§a mÃ¨ne", "Un choix. Pas forcÃ©ment bon ou mauvais, juste un choix", "D'accord, on part sur cette base. Pour l'instant"],
                confirmation: ["Ah. Un schÃ©ma se dessine. PrÃ©visible", "Confirmation de la tendance. L'algorithme apprÃ©cie", "PrÃ©visible. Mais dans le bon sens du terme", "CohÃ©rent. J'aime la cohÃ©rence. C'est reposant", "On reste sur le mÃªme cap. Efficace"],
                conclusion: ["Bon, le profil est Ã©tabli. Pas de surprises", "Verdict : profil identifiÃ©. Simple, en fait", "On a assez de donnÃ©es pour porter un jugement. Et le jugement est : bon", "Analyse terminÃ©e. C'est clair comme de l'eau de roche"]
            },
            dislike: {
                exploration: ["NotÃ©. Une premiÃ¨re piste Ã©cartÃ©e", "OK. On sait ce que tu n'es pas. C'est un dÃ©but", "PremiÃ¨re information par la nÃ©gative. Utile", "Bien. L'Ã©limination est une mÃ©thode valide"],
                confirmation: ["La tendance au rejet se confirme. IntÃ©ressant", "CohÃ©rent dans le refus. Au moins, tu es dÃ©cidÃ©(e)", "Encore un 'non'. Tes critÃ¨res de sÃ©lection sont... stricts", "Le pÃ©rimÃ¨tre se resserre. C'est mathÃ©matique", "NotÃ©. Et classÃ© sans suite"],
                conclusion: ["Profil par exclusion complÃ©tÃ©. On sait ce qu'il te faut : pas Ã§a", "Le portrait-robot de tes aversions est terminÃ©", "Analyse terminÃ©e. Tes 'non' sont plus Ã©loquents que tes 'oui'", "Bon. Ã‡a, c'est une information. Une information trÃ¨s claire"]
            }
        },
        sujets: {
            Gout_Persillage: [{ text: "la faction des 'plus de goÃ»t, moins de questions'", isPlural: false }, { text: "le choix de ceux qui ont dÃ©jÃ  lu la fin du livre", isPlural: false }, { text: "le parti pris de la saveur maximale", isPlural: false }, { text: "la stratÃ©gie 'haut risque, haute rÃ©compense'", isPlural: false }, { text: "la recherche de la vÃ©ritÃ©... dans le gras", isPlural: false }, { text: "le principe de 'cause Ã  effet' culinaire", isPlural: false }, { text: "l'investissement dans le capital-saveur", isPlural: false }, { text: "le thÃ©orÃ¨me du goÃ»t qui l'emporte toujours", isPlural: false }],
            Tendrete_Jutosite: [{ text: "la doctrine du 'moindre effort buccal'", isPlural: false }, { text: "l'option 'zÃ©ro prise de tÃªte'", isPlural: false }, { text: "le choix qui Ã©vite les dÃ©bats et les couteaux mal aiguisÃ©s", isPlural: false }, { text: "le plan de secours qui devient le plan A", isPlural: false }, { text: "la philosophie du 'Ã§a va bien se passer'", isPlural: false }, { text: "le kit de dÃ©marrage pour un repas sans incident", isPlural: false }, { text: "la zone de confort, mais en version comestible", isPlural: false }, { text: "le choix anti-stress par excellence", isPlural: false }],
            Equilibre: [{ text: "le classique 'Ã§a marche Ã  chaque fois'", isPlural: false }, { text: "le choix par dÃ©faut de l'univers", isPlural: false }, { text: "le summum du pragmatisme", isPlural: false }, { text: "le bon sens transformÃ© en dÃ®ner", isPlural: false }, { text: "la loi du 80/20 appliquÃ©e Ã  {possessif_s} assiette", isPlural: false }, { text: "la solution qui fonctionne, fin de la discussion", isPlural: false }, { text: "le couteau suisse de {possessif_s} appÃ©tit", isPlural: false }, { text: "cette tendance un peu trop Ã©vidente chez toi", isPlural: false }, { text: "l'algorithme interne de la faim", isPlural: false }, { text: "le systÃ¨me d'exploitation de {possessif_s} estomac", isPlural: false }, { text: "{possessif_s} historique de dÃ©cisions alimentaires", isPlural: false }, { text: "ce morceau qui a probablement son propre fan club", isPlural: false }, { text: "la mise Ã  jour de {possessif_p} propres certitudes", isPlural: false }],
            all_styles: [{ text: "{possessif_s} instinct primaire qui a pris le dessus", isPlural: false }, { text: "la petite voix bureaucratique dans ta tÃªte qui a dit 'approuvÃ©'", isPlural: false }, { text: "le diagramme de Venn entre 'j'ai faim' et 'maintenant'", isPlural: false }, { text: "le point final de {possessif_s} appÃ©tit", isPlural: false }, { text: "ce choix, probablement sponsorisÃ© par la logique", isPlural: false }, { text: "l'anomalie dans {possessif_s} rÃ©gime alimentaire", isPlural: false }, { text: "{possessif_s} subconscient qui a faim et qui est pressÃ©", isPlural: false }, { text: "le plan A, parce que le plan B implique une salade", isPlural: false }, { text: "la dÃ©finition du mot 'inÃ©vitable'", isPlural: false }, { text: "ce rÃ©flexe conditionnÃ© par des millÃ©naires d'Ã©volution", isPlural: false }, { text: "la piÃ¨ce maÃ®tresse de la chaÃ®ne alimentaire personnelle", isPlural: false }, { text: "le concept mÃªme de 'ne pas se poser de questions'", isPlural: false }]
        },
        verbes: {
            like: [
                { root: "valider", adverb: "cette hypothÃ¨se" },
                { root: "confirmer", adverb: "ce qui Ã©tait dÃ©jÃ  une Ã©vidence" },
                { root: "cibler", adverb: "avec une efficacitÃ© redoutable" },
                { root: "officialiser", adverb: "{possessif_s} penchant pour ce style" },
                { root: "optimiser", adverb: "le ratio plaisir/temps" },
                { root: "court-circuiter", adverb: "toute autre possibilitÃ©" },
                { root: "pointer", adverb: "directement vers la solution" },
                { root: "sÃ©lectionner", adverb: "comme si c'Ã©tait le seul choix logique" },
                { root: "prioriser", adverb: "l'essentiel" },
                { root: "trancher", adverb: "sans la moindre hÃ©sitation" },
                { root: "aligner", adverb: "sur {possessif_p} principes fondamentaux" },
                { root: "calibrer", adverb: "{possessif_p} prÃ©fÃ©rences futures" },
                { root: "authentifier", adverb: "{possessif_s} statut de connaisseur" },
                { root: "condenser", adverb: "{possessif_p} envies en une seule image" },
                { root: "exÃ©cuter", adverb: "le plan sans accroc" }
            ],
            dislike: [
                { root: "rejeter", adverb: "avec une logique implacable" },
                { root: "ignorer", adverb: "comme un appel d'un numÃ©ro masquÃ©" },
                { root: "invalider", adverb: "cette proposition" },
                { root: "filtrer", adverb: "sans pitiÃ©" },
                { root: "Ã©carter", adverb: "comme une thÃ©orie du complot" },
                { root: "mettre", adverb: "sur la liste d'attente... pour toujours" },
                { root: "archiver", adverb: "dans la catÃ©gorie 'fausse bonne idÃ©e'" },
                { root: "dÃ©classer", adverb: "cette option" },
                { root: "refuser", adverb: "avec la politesse d'un e-mail automatique" },
                { root: "bloquer", adverb: "l'accÃ¨s Ã  {possessif_s} assiette" },
                { root: "passer", adverb: "directement Ã  la suite" },
                { root: "rÃ©futer", adverb: "cet argument par l'action" },
                { root: "annuler", adverb: "ce contrat tacite" },
                { root: "purger", adverb: "de la liste des options viables" },
                { root: "Ã©viter", adverb: "comme une rÃ©union le vendredi aprÃ¨s-midi" }
            ]
        },
        complements: {
            BÅ“uf: ["avec la certitude tranquille de ceux qui ont raison", "comme un classique du rock, Ã§a ne vieillit jamais", "parce que parfois, il n'y a pas besoin de rÃ©inventer la roue", "avec la subtilitÃ© d'un tank qui livre des fleurs", "le choix par dÃ©faut de l'humanitÃ© depuis 10 000 ans", "la solution Ã  99% des problÃ¨mes qui impliquent d'avoir faim", "un vote pour la tradition et le bon gras", "la version comestible d'un fauteuil confortable", "parce que 'salade' a rarement rendu quelqu'un heureux", "le point Godwin de la faim"],
            Porc: ["plus fiable que ton Wi-Fi", "parce que le croustillant est une forme d'art", "la preuve que les choses simples sont les meilleures", "le couteau suisse de la cuisine", "un choix qui sent bon le dimanche midi", "la dÃ©finition mÃªme du mot 'gourmandise'", "Ã§a se marie avec tout, mÃªme avec plus de porc", "le doudou comestible de l'humanitÃ©", "la rÃ©ponse Ã©conomique Ã  une question existentielle"],
            Volaille: ["le choix qui ne dÃ©clenchera pas de guerre familiale", "la diplomatie par l'assiette", "la toile blanche de tes talents de cuisinier", "parce que des fois, on veut juste manger sans rÃ©flÃ©chir", "le mode 'sans Ã©chec' de la cuisine", "un choix si raisonnable que c'en est presque suspect", "la preuve qu'on peut Ãªtre lÃ©ger et dÃ©licieux", "le champion de la polyvalence", "le morceau qui met tout le monde d'accord, mÃªme les gens bizarres", "le 'Ã§a passe' qui devient un 'c'est excellent'"],
            default: ["parce que le gras, c'est l'information qui donne le goÃ»t Ã  la vie", "avec la certitude de quelqu'un qui a raison sur Internet", "comme un fichier .zip de saveur pure", "c'est pas une opinion, c'est un fait", "la solution Ã©lÃ©gante Ã  un problÃ¨me primaire", "un choix qui met fin Ã  tous les dÃ©bats", "parce que la vie est trop courte pour les viandes fades", "une dÃ©cision logique et inÃ©vitable", "Ã§a coche toutes les cases", "un investissement Ã  court terme pour un bonheur immÃ©diat", "la quintessence du 'j'ai faim'", "le genre de choix qui fait hocher la tÃªte des connaisseurs", "une Ã©vidence mathÃ©matique", "c'est propre, c'est net, c'est sans bavure", "le sommet de la pyramide alimentaire, tout simplement"]
        }
    };
    function conjugateVerb(root, isPlural) {
        if (isPlural) {
            if (root.endsWith('er')) return root.slice(0, -2) + 'ent';
            if (root.endsWith('ir')) return root.slice(0, -2) + 'issent';
            return root + 'ent';
        } else {
            if (root.endsWith('er')) return root.slice(0, -2) + 'e';
            if (root.endsWith('ir')) return root.slice(0, -2) + 'it';
            if (root.endsWith('tre')) return root.slice(0, -2); 
            return root;
        }
    }
function buildGrammaticalSentence(sujetData, verbeData, complText, user) {
    const useTutoiement = (user?.nom?.trim() || "vous") !== "vous";
    const conjugated = conjugateVerb(verbeData.root, sujetData.isPlural);
    const pronoun = useTutoiement ? (/^[aeiouhÃ Ã¢Ã©Ã¨Ãª]/i.test(conjugated) ? "t'" : "te ") : "vous ";
    
    const formatData = {
        possessif_s: useTutoiement ? "ton" : "votre",
        possessif_p: useTutoiement ? "tes" : "vos",
        prenom: user.nom ? user.nom.charAt(0).toUpperCase() + user.nom.slice(1) : "vous"
    };

    const sujetText = formatText(sujetData.text, formatData);
    const mainClause = `${sujetText} qui ${pronoun}${conjugated}`;
    const adverbPart = verbeData.adverb ? ` ${formatText(verbeData.adverb, formatData)}` : "";

    return `${mainClause}${adverbPart}, ${complText}`;
}

    function pickUnique(arr, lastValue) {
        if (!arr || !arr.length) return "";
        let choice;
        let safety = 0;
        do { choice = arr[Math.floor(Math.random() * arr.length)]; safety++; } 
        while (choice === lastValue && arr.length > 1 && safety < 15);
        return choice;
    }
    const narrativeMemory = { lastPhase: null, streakLikes: 0, streakDislikes: 0 };
    function updateNarrativeStyle(state, memory) {
        const actions = (memory.lastActions || []).slice(-6);
        if (actions.length < 3) return state.user.styleNarratif;
        const likes = actions.filter(a => a.action === "like").length;
        const dislikes = actions.filter(a => a.action === "dislike").length;
        const sameCategory = actions.every(a => a.categorie === actions[0].categorie);
        const categories = [...new Set(actions.map(a => a.categorie))];
        const consistency = sameCategory || categories.length <= 2;
        let newStyle = state.user.styleNarratif || "sobre";
        if (likes >= 4 && !consistency) newStyle = "curieux";
        else if (likes >= 4 && consistency) {
            if (newStyle === "sobre") newStyle = "complice";
            else if (newStyle === "complice") newStyle = "romantique";
            else newStyle = "complice";
        } else if (dislikes >= 3) newStyle = "humoristique";
        else if (likes >= 2 && dislikes >= 2) newStyle = "sobre";
        if (newStyle !== state.user.styleNarratif) {
            console.log(`ðŸŽ­ Style narratif Ã©volue : ${state.user.styleNarratif} â†’ ${newStyle}`);
            state.user.styleNarratif = newStyle;
        }
        return newStyle;
    }
    function adaptNarrativeTone(phase, action) {
        let prefix = "", suffix = "";
        if (action === "like") {
            const suffixes = ["Ã‡a devient intÃ©ressant.", "Je crois quâ€™on touche juste.", "Continue comme Ã§a.", "Bon rÃ©flexe.", "C'est notÃ©.", "On est sur la bonne voie.", "Excellent choix."];
            suffix = " " + suffixes[Math.floor(Math.random() * suffixes.length)];
            narrativeMemory.streakLikes++;
            narrativeMemory.streakDislikes = 0;
        } else {
            narrativeMemory.streakDislikes++;
            narrativeMemory.streakLikes = 0;
        }
        if (narrativeMemory.streakLikes >= 3 && phase !== "conclusion") {
            const streakPrefixes = ["On commence Ã  bien se comprendre.", "Je te vois venir...", "On est presque en phase.", "Tes goÃ»ts sont constants."];
            prefix = streakPrefixes[Math.floor(Math.random() * streakPrefixes.length)];
            narrativeMemory.streakLikes = 0;
        }
        if (narrativeMemory.streakDislikes >= 3) {
            const streakPrefixes = ["Difficile Ã  sÃ©duire.", "Tu es exigeant(e), dis-moi.", "Rien ne semble te plaire aujourd'hui ?", "La quÃªte du morceau parfait est ardue."];
            prefix = streakPrefixes[Math.floor(Math.random() * streakPrefixes.length)];
            narrativeMemory.streakDislikes = 0;
        }
        narrativeMemory.lastPhase = phase;
        return { prefix: prefix, suffix: suffix };
    }
    function detectNarrativeStyle(user) {
        const name = (user.nom || "").toLowerCase();
        const genre = user.genre?.toLowerCase() || "";
        if (name.includes("r2") || name.includes("bot") || name.includes("robot")) return "humoristique";
        if (genre === "madame") return "romantique";
        if (genre === "monsieur" && name.endsWith("o")) return "complice";
        if (name.endsWith("ine") || name.endsWith("elle")) return "curieux";
        return "sobre";
    }
    function buildDynamicSentence(user, profile, phase, action, meatCategory) {
        const allSujets = [...GABARITS.sujets.Gout_Persillage, ...GABARITS.sujets.Tendrete_Jutosite, ...GABARITS.sujets.Equilibre, ...GABARITS.sujets.all_styles];
        const sujetData = pickUnique(allSujets, memory.lastSujet);
        memory.lastSujet = sujetData;
        const verbeData = pickUnique(GABARITS.verbes[action], memory.lastVerbe);
        memory.lastVerbe = verbeData;
        const complText = pickUnique(GABARITS.complements[meatCategory] || GABARITS.complements.default, memory.lastCompl);
        memory.lastCompl = complText;
        const baseSentence = buildGrammaticalSentence(sujetData, verbeData, complText, user);
        const tone = adaptNarrativeTone(phase, action);
        let intro, finalSentence;
        const ponctuation = pickUnique([".", "...", "!"])[0];
        if (tone.prefix) {
            intro = tone.prefix;
            finalSentence = `${intro.trim()} ${baseSentence.charAt(0).toUpperCase() + baseSentence.slice(1)}${ponctuation}${tone.suffix}`;
        } else {
            intro = pickUnique(GABARITS.intros[action][phase], memory.lastIntro);
            memory.lastIntro = intro;
            finalSentence = `${intro.trim()} : ${baseSentence}${ponctuation}${tone.suffix}`;
        }
        return finalSentence.replace(/\[?\s*prenom\s*\]?/gi, user?.nom?.trim() || "vous");
    }
    function generateNarrativeFeedback(user, profile, phase, action, meatCategory) {
        if (action === 'dislike') {
            return pickUnique([
                "C'est notÃ©.", 
                "Message reÃ§u, on affine.", 
                "Parfait, Ã§a clarifie les choses.", 
                "Compris, on oublie celui-lÃ .", 
                "Le choix se resserre."
            ]);
        }
        updateNarrativeStyle(state, memory);
        const baseSentence = buildDynamicSentence(user, profile, phase, action, meatCategory);
        return baseSentence;
    }
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT DU BLOC MODIFIÃ‰ : requestLocation (v2) =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

async function requestLocation() {
    const setDefaultLocation = () => {
        state.user.city = "Neuilly-Plaisance";
        state.user.coords = { lat: 48.86, lon: 2.50 }; // âœ… CoordonnÃ©es par dÃ©faut pour Neuilly-Plaisance
    };

    if (!navigator.geolocation) {
        setDefaultLocation();
        return;
    }

    try {
        const position = await new Promise((resolve, reject) => 
            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 })
        );
        const { latitude: lat, longitude: lon } = position.coords;
        state.user.coords = { lat, lon }; // âœ… On stocke les coordonnÃ©es de l'utilisateur

        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
        if (!response.ok) throw new Error('API Nominatim failed');
        
        const data = await response.json();
        state.user.city = data.address.city || data.address.town || data.address.village || "Lieu inconnu";
    } catch (error) {
        console.warn("GÃ©olocalisation refusÃ©e ou Ã©chouÃ©e. Utilisation de la localisation par dÃ©faut."); // âœ… Message plus clair
        setDefaultLocation();
    }
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN DU BLOC MODIFIÃ‰ : requestLocation (v2) =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */


    function calculateScore(p, pr) { let s = 0; const w = { tendrete: 0.3, gout: 0.3, jutosite: 0.15, persillage: 0.15, destination: 0.1 }; s += (1 - Math.abs(p.Tendrete - pr.Tendrete) / 10) * w.tendrete; s += (1 - Math.abs(p.Gout - pr.Gout) / 10) * w.gout; s += (1 - Math.abs(p.Jutosite - pr.Jutosite) / 10) * w.jutosite; s += (1 - Math.abs(p.Persillage - pr.Persillage) / 10) * w.persillage; if (pr.Destination && p.Destination.includes(pr.Destination)) s += 1 * w.destination; return s * 100 + (Math.random() * 5); }
    function getConvergenceDistance() {
        const history = state.profileHistory;
        if (history.length < 5) return Infinity; 
        const currentProfile = history[history.length - 1];
        const oldProfile = history[history.length - 5]; 
        if (!oldProfile) return Infinity;
        let distance = Math.abs(currentProfile.Tendrete - oldProfile.Tendrete) + 
                       Math.abs(currentProfile.Gout - oldProfile.Gout) + 
                       Math.abs(currentProfile.Jutosite - oldProfile.Jutosite) + 
                       Math.abs(currentProfile.Persillage - oldProfile.Persillage);
        return distance;
    }
function checkForConvergence() {
        const CONVERGENCE_THRESHOLD = 1.2; 
        const distance = getConvergenceDistance();
        if (state.user.nom === "ulyssecampiglia") console.log(`ðŸ”Ž Convergence Check: Distance = ${distance.toFixed(2)} (Seuil: ${CONVERGENCE_THRESHOLD})`); // âœ… Correction
        return distance < CONVERGENCE_THRESHOLD;
    }
    function calculateConvergenceProgress() {
        const distance = getConvergenceDistance();
        const CONVERGENCE_THRESHOLD = 1.2;
        const MAX_DISTANCE_FOR_GAUGE = 8.0;
        if (distance <= CONVERGENCE_THRESHOLD) {
            return 100;
        }
        const progress = 100 * (1 - ((distance - CONVERGENCE_THRESHOLD) / (MAX_DISTANCE_FOR_GAUGE - CONVERGENCE_THRESHOLD)));
        return Math.max(0, Math.min(99, Math.round(progress)));
    }
    function updateConvergenceGauge() {
        const progress = calculateConvergenceProgress();
        const fillEl = document.getElementById('convergence-fill');
        const percentEl = document.getElementById('convergence-percent');
        if (fillEl && percentEl) {
            fillEl.style.width = `${progress}%`;
            percentEl.textContent = `${progress}%`;
        }
        const labelEl = document.querySelector('.convergence-gauge-label');
        if (labelEl) {
            if (state.hasNewHint) {
                labelEl.classList.add('has-hint');
            } else {
                labelEl.classList.remove('has-hint');
            }
        }
    }
    function getUniqueMatchPhrase() {
        if (!state.availableMatchPhrases || state.availableMatchPhrases.length === 0) {
            state.availableMatchPhrases = [...MATCH_PHRASES];
        }
        const randomIndex = Math.floor(Math.random() * state.availableMatchPhrases.length);
        const chosenPhrase = state.availableMatchPhrases.splice(randomIndex, 1)[0];
        return chosenPhrase;
    }

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT BLOC MODIFIÃ‰ : triggerFinalMatchAnimation (v4) =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

function triggerFinalMatchAnimation(finalCard) {
    if (state.user.nom === "ulyssecampiglia") console.log("ðŸŽ‰ CONVERGENCE ATTEINTE ! Lancement de l'animation de Match.");
    const deck = document.querySelector('.card-deck');
    if (deck) deck.style.pointerEvents = 'none';

    const meatData = finalCard.meatData; 

    const alreadyExists = state.convergenceMatches.some(match => match.product.Produit === meatData.Produit);
    if (!alreadyExists) {
        const score = calculateScore(meatData, state.profile);
        state.convergenceMatches.push({ product: meatData, score: score });
        if (state.user.nom === "ulyssecampiglia") console.log(`ðŸ† Match de convergence ajoutÃ© : ${meatData.Produit}`);
    }
    
    const matchOverlay = document.getElementById('match-screen-overlay');
    const userPfp = document.getElementById('user-match-pfp');
    const meatPfp = document.getElementById('meat-match-pfp');
    const matchSubtitle = document.getElementById('match-subtitle');
    const viewProfileBtn = document.getElementById('view-profile-btn');
    const continueSwipingBtn = document.getElementById('continue-swiping-btn-match');

    if (!matchOverlay || !userPfp || !meatPfp || !matchSubtitle || !viewProfileBtn || !continueSwipingBtn) return;

    const closeMatchScreen = (callback) => {
        anime({
            targets: '.match-content-wrapper',
            opacity: 0,
            scale: 0.9,
            duration: 400,
            easing: 'easeInExpo',
            complete: () => {
                matchOverlay.classList.remove('is-visible');
                anime.set(['.match-pfp', '.match-title', '.match-subtitle', '.btn-match-profile', '#continue-swiping-btn-match', '.match-content-wrapper'], { opacity: 0, scale: 1, translateY: 0 });
                if (callback) callback();
            }
        });
    };

    const userLogoUrl = "https://raw.githubusercontent.com/metscarnes/bimi-metscarnes/main/Logo%20Mets%20Carn%C3%A9s%20HD.png";

    const formatData = {
        prenom: state.user.nom ? state.user.nom.charAt(0).toUpperCase() + state.user.nom.slice(1) : "Vous",
        produit_avec_article: formatProduitAvecArticle(meatData), // âœ… On passe l'objet entier
        produit_de: formatProduitContractionDe(meatData), // âœ… On passe l'objet entier
        produit_lieu: formatProduitPourLieu(meatData.Produit),
        e_accord: state.user.genre === 'Madame' ? 'e' : ''
    };
    
    const phraseTemplate = getUniqueMatchPhrase();
    const finalPhrase = formatText(phraseTemplate, formatData);

    if (state.user.nom === "ulyssecampiglia") {
        console.log("ðŸ’¬ Phrase de Match gÃ©nÃ©rÃ©e:", `"${finalPhrase}"`);
        
        if (typeof logMETS === "function") {
            logMETS({
                time: new Date().toLocaleTimeString(),
                produit: formatProduitAvecArticle(meatData), // âœ… On passe l'objet entier
                type: "MATCH",
                phrase: finalPhrase,
                style: "â€”",
                phase: "convergence"
            });
        }
    }

    userPfp.style.backgroundImage = `url('${userLogoUrl}')`;
    meatPfp.style.backgroundImage = `url('${meatData.image_url || "https://via.placeholder.com/450x600/1a1614/d4b896?text=ðŸ¥©"}')`;
    matchSubtitle.textContent = finalPhrase;

    const newProfileBtn = viewProfileBtn.cloneNode(true);
    viewProfileBtn.parentNode.replaceChild(newProfileBtn, viewProfileBtn);
    newProfileBtn.addEventListener('click', () => closeMatchScreen(() => renderProfileScreen(meatData))); 

    const newContinueBtn = continueSwipingBtn.cloneNode(true);
    continueSwipingBtn.parentNode.replaceChild(newContinueBtn, continueSwipingBtn);
    newContinueBtn.addEventListener('click', () => closeMatchScreen(() => { 
        showAppScreen('swipe'); 
        renderSwipe(); 
    }));

    matchOverlay.classList.add('is-visible');

    const tl = anime.timeline({
        easing: 'easeOutExpo',
        duration: 800
    });

    tl.add({
        targets: '.match-content-wrapper',
        opacity: [0, 1]
    })
    .add({
        targets: '#user-match-pfp',
        translateX: 0,
        scale: 1,
        opacity: 1,
        rotate: '-10deg'
    }, '-=600')
    .add({
        targets: '#meat-match-pfp',
        translateX: 0,
        scale: 1,
        opacity: 1,
        rotate: '10deg'
    }, '-=600')
    .add({
        targets: '.match-title',
        translateY: 0,
        opacity: 1,
        duration: 600
    }, '-=400')
    .add({
        targets: '.match-subtitle',
        translateY: 0,
        opacity: 1,
        duration: 500
    }, '-=300')
    .add({
        targets: ['#view-profile-btn', '#continue-swiping-btn-match'],
        translateY: 0,
        opacity: 1,
        duration: 500,
        delay: anime.stagger(100, {start: 200})
    }, '-=200');
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN BLOC MODIFIÃ‰ : triggerFinalMatchAnimation (v4) =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC MODIFIÃ‰ : refreshDeck ========= */
/* ========================================================== */

function refreshDeck() {
    if (state.user.nom === "ulyssecampiglia") { // âœ… Correction
        if (state.profile.interdits && state.profile.interdits.length > 0) {
            console.groupCollapsed(`ðŸš« Filtrage initial des produits basÃ© sur le questionnaire`);
            const forbiddenCategories = state.profile.interdits;
            console.log(`CatÃ©gories interdites par l'utilisateur :`, forbiddenCategories);
            const excludedProducts = ALL_PRODUCTS.filter(p => forbiddenCategories.includes(p.Categorie));
            const excludedCounts = excludedProducts.reduce((acc, p) => {
                acc[p.Categorie] = (acc[p.Categorie] || 0) + 1;
                return acc;
            }, {});
            console.log("DÃ©tail des produits exclus par catÃ©gorie :");
            Object.entries(excludedCounts).forEach(([categorie, count]) => {
                console.log(`- ${categorie}: ${count} produits retirÃ©s`);
            });
            const totalInitial = ALL_PRODUCTS.length;
            const totalFinal = totalInitial - excludedProducts.length;
            console.log(`%cRÃ©sultat : ${totalInitial} produits au dÃ©part âž” ${totalFinal} produits potentiels restants.`, 'color: #f9b930; font-weight: bold;');
            console.groupEnd();
        } else {
            console.log(`%câœ… Aucun filtre 'interdit' appliquÃ© par l'utilisateur. Tous les types de produits sont inclus.`, 'color: #2de9a1;');
        }
    }

    const remaining = ALL_PRODUCTS.filter(p => 
        !state.swipedProductNames.has(p.Produit) && 
        !(state.profile.interdits || []).includes(p.Categorie)
    );

    if (remaining.length === 0) {
        state.deck = [];
        // âœ… La ligne showFeedbackMessage a Ã©tÃ© supprimÃ©e ici.
        return;
    }

    const scored = remaining.map(p => ({ p, score: calculateScore(p, state.profile) }));
    scored.sort((a, b) => b.score - a.score);
    state.deck = scored.map(item => item.p);

    if (state.user.nom === "ulyssecampiglia") { // âœ… Correction
        console.log(`%cðŸ”„ DECK CONSTRUIT`, 'color: #87CEEB; font-weight: bold;', `(${state.deck.length} cartes) Prochaines cartes : ${state.deck.slice(0, 3).map(p => p.Produit).join(', ')}`);
    }
}

/* ========================================================== */
/* ========= FIN DU BLOC MODIFIÃ‰ : refreshDeck ========= */
/* ========================================================== */
    function calculateAndGetNextCard() {
        if (state.deck.length === 0) refreshDeck();
        return state.deck.shift() || null;
    }
    function adaptProfileOnMatch(m, p) { const l = p ? 0.3 : -0.1; for (const k of ['Tendrete', 'Gout', 'Jutosite', 'Persillage']) { if (m[k] !== undefined) { state.profile[k] += (m[k] - state.profile[k]) * l; state.profile[k] = Math.max(0, Math.min(10, state.profile[k])); } } }


/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ REMPLACER : renderIntro (Structure HTML CorrigÃ©e) ========= */
/* ========================================================== */

function renderIntro() {
        DOM.appScreens.intro.innerHTML = `
            <div id="intro-step-1" class="intro-step is-active">
                <div id="dialogue">
                    <p>Bonjour ðŸ‘‹</p>
                    <p>Moi, c'est Ulysse... Et vous ?</p>
                </div>
                <div class="inputs">
                    <div class="buttons">
                        <button class="btn-genre" data-genre="Monsieur">Monsieur</button>
                        <button class="btn-genre" data-genre="Madame">Madame</button>
                    </div>
                    <input type="text" id="name-input" placeholder="Votre prÃ©nom">
                </div>
                <button class="btn" id="btn-next-step">C'est moi !</button>
            </div>
            <div id="intro-step-2" class="intro-step">
                <p id="intro-greeting" style="font-size: 1.5rem; margin-bottom: 2rem;"></p>
                <div class="buttons" style="justify-content: center; flex-wrap: wrap;">
                    <button class="btn" id="btn-full-start">
                        Guidez-moi <span style="font-size: 0.8em;">(Questionnaire)</span>
                    </button>
                    <button class="btn" id="btn-fast-start">
                        J'ai la dalle ! <span style="font-size: 0.8em;">(Swipe direct)</span>
                    </button>
                </div>
            </div>
        `;
        const style = document.createElement('style');
        style.textContent = `
            .intro-step { opacity: 0; transform: translateY(20px); transition: all 0.5s ease; pointer-events: none; position: absolute; }
            .intro-step.is-active { opacity: 1; transform: translateY(0); pointer-events: auto; position: relative; display: flex; flex-direction: column; align-items: center; gap: 1.5rem;}
            .intro-step.is-active .inputs { opacity: 1; }
        `;
        DOM.appScreens.intro.appendChild(style);
        bindIntroEvents();
    }

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ REMPLACER : renderIntro (Structure HTML CorrigÃ©e) ========= */
/* ========================================================== */
function renderQuestionStep() {
    const s = QUESTION_STEPS[state.currentStep];
    if (!s) {
        transitionToLoading();
        return;
    }
    let a = s.type === "multi" ?
        `<div class="answers">${ESPECES.map(e => `<div class="answer-card small-text" data-value="${e.name}"><span class="icon">${e.emoji}</span><span class="text">${e.name}</span></div>`).join('')}</div><button class="btn" id="q-next">Continuer</button>` :
        `<div class="answers">${s.options.map((o, i) => `<div class="answer-card" data-index="${i}">${s.icons?`<span class="icon">${s.icons[i]}</span>`:''}<span class="text">${o.txt}</span></div>`).join('')}</div>`;
    
    DOM.appScreens.questions.innerHTML = `
        <div id="q-progress">Profil carnÃ© Â· ${s.label}</div>
        <h2 id="q-text">${s.text}</h2>
        ${s.helper?`<p class="question-helper">${s.helper}</p>`:''}
        ${a}
    `;
    bindQuestionEvents();
    
    const savedAnswerIndex = state.userAnswers[s.id];
    if (savedAnswerIndex !== undefined) {
        const answerCards = DOM.appScreens.questions.querySelectorAll('.answer-card');
        if (answerCards[savedAnswerIndex]) {
            answerCards[savedAnswerIndex].classList.add('selected');
        }
    }
}
/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ REMPLACER : renderProfileScreen ========= */
/* ========================================================== */

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT BLOC MODIFIÃ‰ : renderProfileScreen (Lien mÃªme page) =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

function renderProfileScreen(triggeringMatchProduct) {
    if (!DOM.appScreens.profile) {
        const profileScreenEl = document.createElement('div');
        profileScreenEl.id = 'profile-screen';
        profileScreenEl.className = 'screen';
        document.getElementById('screen-root').appendChild(profileScreenEl);
        DOM.appScreens.profile = profileScreenEl;
    }

    const formatData = {
        prenom: state.user.nom ? state.user.nom.charAt(0).toUpperCase() + state.user.nom.slice(1) : "Vous",
        e: state.user.genre === 'Madame' ? 'e' : '',
        ne: state.user.genre === 'Madame' ? 'ne' : ''
    };
    let profileTitle = "Le Pragmatiste Ã‰quilibrÃ©";
    let summaryTemplate = `Pour toi {prenom}, c'est simple : un peu de goÃ»t, un peu de tendresse, et voilÃ . T'es du genre raisonnable. Mais bon, Ã§a marche Ã  tous les coups.`;

if (state.profile.Gout > 7.5 && state.profile.Tendrete < 5) {
    profileTitle = "Le Barbare au Palais Fin";
    summaryTemplate = `T'es un{e} warrior de la mÃ¢choire, {prenom}. La **TendretÃ©** ? C'est pour les fragiles. Toi tu veux du **GoÃ»t**, du vrai, quitte Ã  y passer la soirÃ©e Ã  mastiquer. T'as pas peur de te battre pour ton plaisir.`;
} else if (state.profile.Tendrete > 8 && state.profile.Jutosite > 7) {
    profileTitle = "L'Adepte de la Douceur";
    summaryTemplate = `Ta philosophie {prenom} ? ZÃ©ro effort, max de bonheur. Pour toi, une viande doit fondre toute seule dans ta bouche. **TendretÃ©** et **JutositÃ©** au max, sinon c'est mÃªme pas la peine. T'as autre chose Ã  faire que mÃ¢cher pendant trois plombes.`;
} else if (state.profile.Gout > 8 && state.profile.Persillage > 7) {
    profileTitle = "L'HÃ©doniste du Gras";
    summaryTemplate = `T'as tout compris Ã  la vie, {prenom} : le gras, c'est le bonheur. Tu veux du **GoÃ»t** qui en met plein les papilles et du **Persillage** qui fait des miracles Ã  la cuisson. Les morceaux maigres ? Tu laisses Ã§a Ã  ceux qui font semblant d'aimer leur vie.`;
} else if (state.profile.Tendrete > 7 && state.profile.Gout > 7) {
    profileTitle = "L'Ã‰picurien{ne} Exigeant{e}";
    summaryTemplate = `Le beurre ET l'argent du beurre, voilÃ  ce que tu veux {prenom}. Une viande qui soit **Tendre** comme un nuage ET qui explose en **Saveurs** comme un feu d'artifice. Bref, tu veux tout. Et alors ? T'as bien raison.`;
}

    const stats = { Tendrete: state.profile.Tendrete, Gout: state.profile.Gout, Jutosite: state.profile.Jutosite, Persillage: state.profile.Persillage };
    const sortedStats = Object.entries(stats).sort((a, b) => b[1] - a[1]);
    const [highestStatName, highestStatValue] = sortedStats[0];
    const EXTREME_THRESHOLD = 8.0;
    if (highestStatValue >= EXTREME_THRESHOLD && !summaryTemplate.toLowerCase().includes(highestStatName.toLowerCase())) { const extremeStatSentences = { Gout: " On note tout de mÃªme une recherche quasi obsessionnelle du **GoÃ»t** brut.", Tendrete: " Mais votre signature secrÃ¨te, c'est cette exigence absolue de **TendretÃ©**.", Jutosite: " Cependant, votre vÃ©ritable point faible reste une quÃªte gourmande de **JutositÃ©**.", Persillage: " Mais ne nous mentons pas : au final, ce qui vous trahit, c'est cet amour immodÃ©rÃ© pour un **Persillage** gÃ©nÃ©reux." }; summaryTemplate += extremeStatSentences[highestStatName]; }
    const finalSummary = formatText(summaryTemplate, formatData);
    const finalTitle = formatText(profileTitle, formatData);

    let bestMatch = triggeringMatchProduct;
    if (!bestMatch) {
        const allScores = ALL_PRODUCTS.map(p => ({ p, score: calculateScore(p, state.profile) })).sort((a,b) => b.score - a.score);
        bestMatch = allScores[0]?.p;
    }
    
    const logoUrl = "https://raw.githubusercontent.com/metscarnes/bimi-metscarnes/main/Logo%20Mets%20Carn%C3%A9s%20HD.png";
    const meatImageUrl = bestMatch ? bestMatch.image_url : "https://via.placeholder.com/150/1a1614/d4b896?text=ðŸ¥©";

  const ctaHtml = bestMatch ? 
    `<a href="${bestMatch.product_url || '#'}" class="btn-cta-profile">Ton rendez vous est par ici</a>` : // âœ… L'attribut target="_blank" a Ã©tÃ© supprimÃ© ici.
    ``;

  DOM.appScreens.profile.innerHTML = `
    <div class="profile-container">
            
            <div class="profile-match-visual profile-reveal-item" style="--delay: 0.2s;">
                <div class="profile-match-logo" style="background-image: url('${logoUrl}')"></div>
                <div class="profile-match-meat" style="background-image: url('${meatImageUrl}')"></div>
            </div>

            <h1 class="profile-reveal-item" style="--delay: 0.4s; margin-top: 2rem;">Ton Profil Carnivore</h1>
            
            <h2 class="profile-reveal-item" style="color: var(--accent); font-style: italic; margin-bottom: 2rem; --delay: 0.5s;">"${finalTitle}"</h2>
            
            <p class="profile-reveal-item" style="font-size: 1.2rem; line-height: 1.8; margin-bottom: 3rem; --delay: 0.6s;">${finalSummary.replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--primary);">$1</strong>')}</p>
            
            <div style="width: 280px; height: 280px; margin: 0 auto 1.5rem;">
                <svg id="profile-radar-final" viewBox="0 0 100 100"></svg>
            </div>
            
            <div class="profile-actions-group profile-reveal-item" style="--delay: 0.8s;">
                <div class="profile-recommendation">
                    <h1 class="recommendation-label">On est sympa,<br>on organise votre premier date :</h1>
                </div>
                ${ctaHtml}
                <button class="btn" id="continue-swiping-btn">Continuer Ã  Swiper</button>
            </div>
        </div>`;
        
    drawRadar(state.profile, 'profile-radar-final');
    
  DOM.appScreens.profile.querySelector('#continue-swiping-btn').addEventListener('click', () => {
        showAppScreen('swipe');
        renderSwipe();
    });
    
    showAppScreen('profile');
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN BLOC MODIFIÃ‰ : renderProfileScreen (Lien mÃªme page) =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */


    function parseBioTemplate(template, user) {
        if (!template || !user) return "";
        const userGenre = (user.genre || "").toLowerCase();
        const inverseGenre = userGenre.includes("monsieur") ? "feminin" : "masculin";
        return template.replace(/\{\{(.*?)\}\}/g, (_, content) => {
            const parts = content.split("|").reduce((acc, part) => { const [key, val] = part.split(":").map(s => s.trim()); acc[key] = val; return acc; }, {});
            if (inverseGenre === "feminin") return (parts.adj_f || parts.part_f || parts.nom_f || parts.pro_f || parts.comp_f || parts.alt_f || Object.values(parts)[0] || "");
            else return (parts.adj_m || parts.part_m || parts.nom_m || parts.pro_m || parts.comp_m || parts.alt_m || Object.values(parts)[0] || "");
        });
    }

    function getArticleEtAdjectif(nom, genre = 'masculin', adjectif = '') {
        if (!nom) return { articleDef: '', articleIndef: '', adjFinal: ''};
        const nomTrimmed = nom.trim();
        const startsWithVowel = /^[aeiouhÃ Ã¢Ã©Ã¨ÃªÃ«Ã¯Ã¼]/i.test(nomTrimmed);
        const isFeminin = genre.toLowerCase().startsWith('f');
        const articleDef = startsWithVowel ? "lâ€™" : (isFeminin ? "la " : "le ");
        const articleIndef = isFeminin ? "une " : "un ";
        let adjFinal = adjectif;
        if (startsWithVowel) {
            if (adjectif === 'beau') adjFinal = 'bel';
            if (adjectif === 'vieux') adjFinal = 'vieil';
            if (adjectif === 'nouveau') adjFinal = 'nouvel';
        } else {
            if (isFeminin) {
                if (adjectif === 'beau') adjFinal = 'belle';
                if (adjectif === 'vieux') adjFinal = 'vieille';
                if (adjectif === 'nouveau') adjFinal = 'nouvelle';
            }
        }
        return { articleDef, articleIndef, adjFinal };
    }

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC MODIFIÃ‰ : function createCard ========= */
/* ========================================================== */

function createCard(m, deckElement) {
    const d = deckElement;
    if (!d) {
        console.error("Erreur : L'Ã©lÃ©ment 'deck' n'a pas Ã©tÃ© fourni Ã  createCard.");
        return null;
    }

    const c = document.createElement('div');
  c.className = 'card';
  c.dataset.produit = m.Produit;
  c.meatData = m;

  c.innerHTML = `
    <div class="card-choice like">Match</div>
    <div class="card-choice nope">Next</div>
    <div class="card-media" style="background-image: url('${m.image_url || "https://via.placeholder.com/450x600/1a1614/d4b896?text=ðŸ¥©"}')">
      <div class="card-sensor-bars">${createThermoBars(m)}</div>
      <div class="card-gradient-overlay"></div>
    </div>
    <div class="card-info">
      <div class="card-info-content">
        <div class="card-text-wrapper">
          <div class="card-name">${m.Produit}</div>
          <div class="card-location"><span>ðŸ </span> Vit ici : ${state.user.city || 'Neuilly-Plaisance'}</div>
          
        </div>
        <svg class="card-expand-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="stroke: rgba(245,241,232,0.85);">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>
    <a href="#" class="card-external-link" data-produit="${encodeURIComponent(m.Produit)}">
    Ton rendez-vous est ici â†—
    </a>
    </div>
  `; // âœ… La ligne contenant le <p class="card-bio"> a Ã©tÃ© supprimÃ©e ici.
    
    const infoContent = c.querySelector('.card-info-content');
    const externalLink = c.querySelector('.card-external-link');

    if (infoContent) {
        infoContent.addEventListener('click', (e) => {
            e.stopPropagation();
            showProductModal(m);
        });
    }

  if (externalLink) {
    externalLink.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      try { showModal(m); } catch (err) { window.location.href = m.product_url || '#'; }
    });
  }
    
    d.appendChild(c);
    
    return c;
}

/* ========================================================== */
/* ========= FIN DU BLOC MODIFIÃ‰ : function createCard ========= */
/* ========================================================== */

    function createThermoBars(m) {
        const bars = [{ icon: 'ðŸ‘…', label: 'GoÃ»t', value: m.Gout }, { icon: 'ðŸ”ª', label: 'TendretÃ©', value: m.Tendrete }, { icon: 'ðŸ’§', label: 'JutositÃ©', value: m.Jutosite }, { icon: 'âœ¨', label: 'Persillage', value: m.Persillage }];
        return bars.map((b, i) => {
            const v = Math.max(0, Math.min(10, b.value || 5));
            const percent = v * 10;
            const color = v >= 7 ? '#edc196' : v >= 4 ? '#d4a574' : '#b08968';
            return `<div class="thermo-line" style="--delay:${i * 0.25}s;"><div class="thermo-bar-row"><span class="thermo-icon">${b.icon}</span><div class="thermo-bar-container"><div class="thermo-bar-fill" style="--target-width:${percent}%; background:${color};"></div></div></div><span class="thermo-text">${b.label}</span></div>`;
        }).join('');
    }

function updateCardStates() { 
    const cards = DOM.appScreens.swipe.querySelectorAll('.card'); 
    cards.forEach((card, index) => { 
        card.classList.remove('is-active', 'is-next'); 
        if (index === 0) { 
            card.classList.add('is-active'); 
            initCardHammer(card); 
        } 
        else if (index === 1) { 
            card.classList.add('is-next'); 
        }
    }); 
}

function addNextCardToDeckIfNeeded() {
    const deckEl = DOM.appScreens.swipe.querySelector('#card-deck');
    if (!deckEl) return;
    const visualCards = deckEl.querySelectorAll('.card');
    const targetCardCount = Math.min(state.deck.length, 2);

    if (visualCards.length < targetCardCount) {
        const cardDataToAdd = state.deck[visualCards.length];
        if (cardDataToAdd) {
            createCard(cardDataToAdd, deckEl);
        }
    }
}
    
    function showModal(m) { const M = DOM.modals.product; const c = M.querySelector('.modal-content'); if (!c) return; const h = NUTRITIONAL_INFO_MAP.map(n => { const v = m[n.key]; if (v !== undefined && v !== null) return `<div class="nutrient-card"><div class="label">${n.label}</div><div class="value">${String(v).replace('.',',')} ${n.unit}</div></div>`; return ''; }).join(''); c.innerHTML = `<div class="profile-header"><img src="${m.image_url||'https://via.placeholder.com/100/1a1614/d4b896?text=ðŸ¥©'}" alt="${m.Produit}" class="profile-image"><div class="profile-info" style="display:flex;justify-content:space-between;align-items:flex-start;flex-grow:1;"><h1 class="product-title" style="margin-bottom:0;">${m.Produit}</h1><div class="nutri-score-badge"><div class="label">Nutri-Score</div><div class="score score-${m.NutriScore||'C'}">${m.NutriScore||'N/A'}</div></div></div></div><div class="section-grid"><div class="description-section"><p><strong class="description-label">Description :</strong><span>${m.Description || 'N/A'}</span></p>${m.bio_template ? `<div style="margin-top:1.5rem;"><strong class="description-label">Bio comique :</strong><p style="margin-top:0.5rem;color:var(--text-light);font-style:italic;line-height:1.8;">${parseBioTemplate(m.bio_template, state.user)}</p></div>` : ''}<p style="margin-top:1.5rem;"><strong class="description-label">Conseil:</strong><span>${m.CuissonConseillee||'N/A'}</span></p></div><div class="radar-section" style="display:flex;align-items:center;justify-content:center;"><svg id="modal-radar" viewBox="0 0 100 100" style="max-width:250px;"></svg></div></div><div class="card-section"><h2 class="section-title">Valeurs Nutritionnelles</h2><div class="nutrient-grid">${h}</div></div><div class="actions" style="margin-top:2rem;border-top:1px solid var(--border-subtle);padding-top:2rem;"><button class="action-btn" id="modal-dislike-btn">âŒ</button><button class="action-btn" id="modal-like-btn">â¤ï¸</button></div><button id="modal-close-btn" class="btn" style="width:100%;margin-top:1rem;">Fermer</button>`; drawRadar(m, 'modal-radar'); M.classList.add('is-visible'); const t = DOM.appScreens.swipe.querySelector('.card.is-active'); if (!t || t.meatData.Produit !== m.Produit) return; const l = c.querySelector('#modal-like-btn'), d = c.querySelector('#modal-dislike-btn'), C = c.querySelector('#modal-close-btn'); const nL = l.cloneNode(true); l.parentNode.replaceChild(nL, l); const nD = d.cloneNode(true); d.parentNode.replaceChild(nD, d); nL.onclick = () => { M.classList.remove('is-visible'); animateSwipe(t, 1); }; nD.onclick = () => { M.classList.remove('is-visible'); animateSwipe(t, -1); }; C.onclick = () => M.classList.remove('is-visible'); M.onclick = e => { if (e.target === M) M.classList.remove('is-visible'); }; }
function drawRadar(data, svgId) {
    const svg = document.getElementById(svgId);
    if (!svg) return;
    
    const size = 100, center = size / 2;
    const values = [data.Gout || 5, data.Tendrete || 5, data.Persillage || 5, data.Jutosite || 5];
    
    const labels = [
        { class: 'legend-top', emoji: 'ðŸ‘…', name: 'GoÃ»t' },
        { class: 'legend-right', emoji: 'ðŸ”ª', name: 'TendretÃ©' },
        { class: 'legend-bottom', emoji: 'âœ¨', name: 'Persillage' },
        { class: 'legend-left', emoji: 'ðŸ’§', name: 'JutositÃ©' }
    ];

    let points = '';
    let legendsHtml = '';

    values.forEach((v, i) => {
        const angle = -Math.PI / 2 + (i * Math.PI / 2);
        const scale = v / 10;
        const x = center + (center * 0.8 * scale * Math.cos(angle));
        const y = center + (center * 0.8 * scale * Math.sin(angle));
        points += `${x},${y} `;
    });
    
    labels.forEach(label => {
        legendsHtml += `<div class="radar-legend ${label.class}">
                          <span class="emoji">${label.emoji}</span>
                          ${label.name}
                        </div>`;
    });

    const parent = svg.parentNode;
    if (parent && parent.style.position !== 'relative') {
        parent.style.position = 'relative';
    }

    svg.innerHTML = `
        <polygon class="radar-bg" points="50,10 90,50 50,90 10,50" fill="none" stroke="rgba(237,193,150,0.15)" stroke-width="0.6"/>
        <polygon class="radar-shape" points="${points}" fill="rgba(237,193,150,0.5)" stroke="var(--accent)" stroke-width="1"/>
    `;
    
    parent.querySelectorAll('.radar-legend').forEach(el => el.remove());
    parent.insertAdjacentHTML('beforeend', legendsHtml);
}
/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC CORRIGÃ‰ : generateConvergenceHint ========= */
/* ========================================================== */

function generateConvergenceHint() {
    const recentSwipes = state.swipeHistory.slice(-6);
    const minSwipes = 5;

    if (recentSwipes.length < minSwipes) {
        return {
            title: "Un peu de patience...",
            text: `Continuez Ã  swiper ! Il me faut encore ${minSwipes - recentSwipes.length} choix pour analyser vos goÃ»ts. Chaque swipe est un indice !`,
            confirmText: "Compris !",
            isSignificant: false 
        };
    }

    const likedCards = recentSwipes.filter(s => s.decision === 1).map(s => s.meat);
    const dislikedCards = recentSwipes.filter(s => s.decision === -1).map(s => s.meat);

    const traits = [
        { key: 'Tendrete', name: 'TendretÃ©', gender: 'f', high: 'trÃ¨s tendres', low: 'plutÃ´t fermes', adj: 'tendre' },
        { key: 'Gout', name: 'GoÃ»t', gender: 'm', high: 'trÃ¨s savoureux', low: 'plutÃ´t doux', adj: 'savoureux' },
        { key: 'Persillage', name: 'Persillage', gender: 'm', high: 'gÃ©nÃ©reusement persillÃ©s', low: 'plutÃ´t maigres', adj: 'persillÃ©' },
        { key: 'Jutosite', name: 'JutositÃ©', gender: 'f', high: 'bien juteux', low: 'plutÃ´t secs', adj: 'juteux' }
    ];

    const findTopTraits = (cards, threshold, direction, count = 2) => {
        if (cards.length < 2) return [];
        const matchingTraits = traits.filter(trait => {
            return cards.every(card => direction === 'high' ? card[trait.key] >= threshold : card[trait.key] <= threshold);
        });
        return matchingTraits.slice(0, count);
    };

    const mustHaveTraits = findTopTraits(likedCards, 7.0, 'high');
    const dealBreakerTraits = findTopTraits(dislikedCards, 5.0, 'low');
    
    const prenom = state.user.nom ? state.user.nom.charAt(0).toUpperCase() + state.user.nom.slice(1) : "vous";
    const estMadame = state.user.genre === 'Madame';
    const accordE = estMadame ? 'e' : '';

    let title = "Ulysse Ã  la rescousse !";
    let text = `${prenom}, vos goÃ»ts sont assez subtils. Pour m'aider, n'hÃ©sitez pas Ã  faire des choix plus tranchÃ©s : un grand OUI ou un grand NON est plus parlant qu'une hÃ©sitation.`;
    let isSignificant = false; 

    if (mustHaveTraits.length >= 2) {
        title = "Le duo gagnant se prÃ©cise !";
        const [trait1, trait2] = mustHaveTraits;
        text = `C'est clair, ${prenom} : vous Ãªtes conquis${accordE} quand un morceau est Ã  la fois **${trait1.adj}** et **${trait2.adj}**. C'est votre combinaison idÃ©ale !<br/><br/>Cherchez les profils qui excellent sur ces deux points, et la convergence va grimper en flÃ¨che.`;
        isSignificant = true; 
    }
    else if (mustHaveTraits.length === 1 && dealBreakerTraits.length === 1) {
        title = "Analyse stratÃ©gique...";
        const mustHave = mustHaveTraits[0];
        const dealBreaker = dealBreakerTraits[0];
        text = `Message reÃ§u, ${prenom} ! Vous cherchez avant tout un morceau **${mustHave.adj}**, mais vous ne tolÃ©rez absolument pas un manque de **${dealBreaker.name}**.<br/><br/>Votre mission est donc double : maximiser l'un et Ã©viter le pire sur l'autre. Un vrai dÃ©fi d'Ã©quilibriste !`;
        isSignificant = true; 
    }
    else if (mustHaveTraits.length === 1) {
        title = "Votre critÃ¨re nÂ°1 est clair !";
        const mustHave = mustHaveTraits[0];
        text = `Aucun doute, ${prenom} : votre prioritÃ© absolue, c'est la **${mustHave.name}**. Vous validez systÃ©matiquement les morceaux qui sont **${mustHave.high}**.<br/><br/>C'est une excellente base ! Continuons sur cette lancÃ©e pour affiner les autres critÃ¨res.`;
        isSignificant = true; 
    }
    else if (dealBreakerTraits.length === 1) {
        title = "Votre 'non' est trÃ¨s clair !";
        const dealBreaker = dealBreakerTraits[0];
        text = `Une chose est sÃ»re, ${prenom} : vous fuyez les produits qui sont **${dealBreaker.low}**. Le manque de **${dealBreaker.name}** est un critÃ¨re rÃ©dhibitoire pour vous.<br/><br/>C'est un super filtre ! Continuez Ã  Ãªtre aussi sÃ©lectif${accordE}, Ã§a affine Ã©normÃ©ment votre profil.`;
        isSignificant = true; 
    }

    return { title, text: text.replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--primary);">$1</strong>'), confirmText: "StratÃ©gie notÃ©e !", isSignificant }; 
} // âœ… L'accolade manquante est maintenant ici.

/* ========================================================== */
/* ========= FIN DU BLOC CORRIGÃ‰ : generateConvergenceHint ========= */
/* ========================================================== */
/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC MODIFIÃ‰ : showProductModal ========= */
/* ========================================================== */

function showProductModal(product) {
    const modal = document.getElementById('product-modal-overlay');
    const contentContainer = modal.querySelector('.product-modal-content'); // âœ… On cible le conteneur principal
    if (!contentContainer) return;

    // âœ… On prÃ©pare les URLs pour le visuel
    const logoUrl = "https://raw.githubusercontent.com/metscarnes/bimi-metscarnes/main/Logo%20Mets%20Carn%C3%A9s%20HD.png";
    const meatImageUrl = product.image_url || "https://via.placeholder.com/150/1a1614/d4b896?text=ðŸ¥©";

    // Construction du contenu
    let bodyHTML = '';
    if (product.bio_template) {
        const bioText = parseBioTemplate(product.bio_template, state.user);
        bodyHTML += `<p style="font-style: italic; line-height: 1.8; margin-bottom: 1.5rem;">${bioText}</p>`;
    }

    if (product.Energie || product.Proteines || product.Lipides) {
        bodyHTML += '<h3 style="color: var(--primary); margin-top: 1.5rem; margin-bottom: 0.75rem; font-family: \'Loyola Pro Bold\', serif;">Valeurs nutritionnelles (pour 100g)</h3>';
        bodyHTML += '<ul style="list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem 1rem; text-align: left;">';
        if (product.Energie) bodyHTML += `<li>âš¡ Ã‰nergie: ${product.Energie} kcal</li>`;
        if (product.Proteines) bodyHTML += `<li>ðŸ’ª ProtÃ©ines: ${product.Proteines}g</li>`;
        if (product.Lipides) bodyHTML += `<li>ðŸ¥‘ Lipides: ${product.Lipides}g</li>`;
        if (product.Glucides) bodyHTML += `<li>ðŸŒ¾ Glucides: ${product.Glucides}g</li>`;
        if (product.Fer) bodyHTML += `<li>âš™ï¸ Fer: ${product.Fer}mg</li>`;
        if (product.Zinc) bodyHTML += `<li>âœ¨ Zinc: ${product.Zinc}mg</li>`;
        bodyHTML += '</ul>';
    }

    if (product.Interdits && product.Interdits !== 'Aucun') {
        bodyHTML += `<p style="margin-top: 1rem; color: var(--danger);"><strong>âš ï¸ Interdits:</strong> ${product.Interdits}</p>`;
    }

    // âœ… On reconstruit TOUT le contenu du modal avec la nouvelle structure
    contentContainer.innerHTML = `
        <button class="modal-close-btn" id="product-modal-close">âœ•</button>

        <!-- âœ… Visuel (logo + produit) ajoutÃ©, copiÃ© de l'Ã©cran de profil -->
        <div class="profile-match-visual" style="margin: 0 auto 0;">
            <div class="profile-match-logo" style="background-image: url('${logoUrl}')"></div>
            <div class="profile-match-meat" style="background-image: url('${meatImageUrl}')"></div>
        </div>

        <div class="product-modal-header">
            <!-- âœ… Titre et catÃ©gorie mis Ã  jour -->
            <h2 class="product-modal-title" id="product-modal-title">${product.Produit}</h2>
            <p class="product-modal-category" id="product-modal-category">${product.Categorie || ''}</p>
        </div>
        <div class="product-modal-body" id="product-modal-body">
            ${bodyHTML}
        </div>
        <div class="product-modal-footer">
            <a href="#" class="btn btn-primary product-modal-cta" id="product-modal-cta">
                Votre date t'attend ici ðŸ’•
            </a>
        </div>
    `;

    const cta = contentContainer.querySelector('#product-modal-cta');
    const closeBtn = contentContainer.querySelector('#product-modal-close');

    if (product.product_url) {
        cta.href = product.product_url;
        cta.style.display = 'inline-block';
    } else {
        cta.style.display = 'none';
    }

    closeBtn.onclick = () => modal.classList.remove('is-visible');
    modal.onclick = (e) => {
        if (e.target === modal) modal.classList.remove('is-visible');
    };

    modal.classList.add('is-visible');
}

/* ========================================================== */
/* ========= FIN DU BLOC MODIFIÃ‰ : showProductModal ========= */
/* ========================================================== */
function showCustomAlert({ title, text, confirmText = 'Compris', cancelText = null }) { // âœ… Accepte un bouton d'annulation optionnel
    return new Promise(resolve => {
        const modalTitle = document.getElementById('alert-modal-title');
        const modalText = document.getElementById('alert-modal-text');
        const modalButtons = document.getElementById('alert-modal-buttons');
        const modalOverlay = DOM.modals.alert;

        modalTitle.textContent = title;
        modalText.innerHTML = text;

        let buttonsHtml = `<button class="modal-btn modal-btn-confirm">${confirmText}</button>`;
        if (cancelText) { // âœ… Si un texte d'annulation est fourni, on ajoute le deuxiÃ¨me bouton
            buttonsHtml += `<button class="modal-btn modal-btn-secondary">${cancelText}</button>`;
        }
        modalButtons.innerHTML = buttonsHtml;

        const confirmBtn = modalButtons.querySelector('.modal-btn-confirm');
        const cancelBtn = modalButtons.querySelector('.modal-btn-secondary');

        const closeAndResolve = (value) => {
            modalOverlay.classList.remove('is-visible');
            resolve(value); // âœ… Renvoie 'true' pour confirmation, 'false' pour annulation
        };

        confirmBtn.onclick = () => closeAndResolve(true);
        if (cancelBtn) {
            cancelBtn.onclick = () => closeAndResolve(false);
        }
        
        // Permet de fermer en cliquant Ã  l'extÃ©rieur (Ã©quivaut Ã  annuler)
        modalOverlay.onclick = (e) => {
            if (e.target === modalOverlay) {
                closeAndResolve(false);
            }
        };

        modalOverlay.classList.add('is-visible');
    });
}

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ REMPLACER : showCustomAlert ========= */
/* ========================================================== */
    
/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ REMPLACER : handleBackStep ========= */
/* ========================================================== */

async function handleBackStep() { // âœ… La fonction est maintenant asynchrone pour attendre la rÃ©ponse du pop-up
    // Cas 1 : On est sur l'Ã©cran de swipe, de rÃ©sultats ou de profil
    if (state.currentScreen === 'swipe' || state.currentScreen === 'results' || state.currentScreen === 'profile') {
        const confirmed = await showCustomAlert({ // âœ… On attend la confirmation
            title: "Retourner au questionnaire ?",
            text: "Cela rÃ©initialisera votre progression de swipe pour affiner Ã  nouveau votre profil.",
            confirmText: "Oui, retourner",
            cancelText: "Annuler"
        });

        if (confirmed) { // âœ… Si l'utilisateur confirme
            state.currentStep = QUESTION_STEPS.length - 1; // On se positionne sur la derniÃ¨re question
            showAppScreen('questions');
            renderQuestionStep();
        }
        // Si l'utilisateur annule, on ne fait rien.

    // Cas 2 : On est dans le questionnaire, mais pas Ã  la premiÃ¨re question
    } else if (state.currentScreen === 'questions' && state.currentStep > 0) {
        state.currentStep--;
        renderQuestionStep();

    // Cas 3 (implicite) : On est Ã  la premiÃ¨re question. Le bouton retour ne fait plus rien.
    // On a supprimÃ© l'ancien 'else' qui renvoyait Ã  l'Ã©cran d'intro.
    }
}

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ REMPLACER : handleBackStep ========= */
/* ========================================================== */

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-= DÃ‰BUT BLOC MODIFIÃ‰ : renderResultsScreen (Lien mÃªme page) =-=-=-=-=-= */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */

function renderResultsScreen() {
    const resultsContainer = DOM.appScreens.results;
    let content = '';

    if (state.convergenceMatches.length > 0) {
        const userLogoUrl = "https://raw.githubusercontent.com/metscarnes/bimi-metscarnes/main/Logo%20Mets%20Carn%C3%A9s%20HD.png";
        const sortedMatches = [...state.convergenceMatches].sort((a, b) => b.score - a.score);
    const listItems = sortedMatches.map((match, index) => {
            const product = match.product;
            const compatibility = Math.min(99, Math.round(match.score));
            return `
                <li class="match-gallery-item" style="--delay: ${index * 0.1}s;">
                    <div class="match-gallery-pfps">
                        <div class="user-pfp" style="background-image: url('${userLogoUrl}')"></div>
                        <div class="product-pfp" style="background-image: url('${product.image_url || "https://via.placeholder.com/150/1a1614/d4b896?text=ðŸ¥©"}')"></div>
                    </div>
                    <div class="match-gallery-info">
                        <h3>${product.Produit}</h3>
                        <p class="match-compatibility">ðŸ† Profil idÃ©al validÃ© Ã  ${compatibility}%</p>
            <a href="${product.product_url || '#'}" class="btn-view-product">Ton date est ici</a>
                    </div>
                </li>
            `; // âœ… L'attribut target="_blank" a Ã©tÃ© supprimÃ© du lien ici.
        }).join('');

        content = `
            <h1>Vos Profils IdÃ©aux</h1>
            <p class="results-subtitle">Voici les matchs validÃ©s par l'algorithme de convergence.</p>
            <ul id="matches-list">${listItems}</ul>
        `;
    } else {
        content = `
            <h1>Vos Profils IdÃ©aux</h1>
            <p class="results-subtitle">L'algorithme n'a pas encore validÃ© de profil idÃ©al pour vous.</p>
            <div class="no-matches-message">
                <p>Continuez Ã  swiper pour atteindre votre premiÃ¨re convergence !</p>
            </div>
        `;
    }

    resultsContainer.innerHTML = `
        <button id="view-profile-from-results-btn">Voir mon dernier profil</button> 
        ${content}
        <div class="results-actions">
            <button class="btn" id="continue-swiping-from-results">Continuer Ã  Swiper</button>
        </div>
    `;

    resultsContainer.querySelector('#view-profile-from-results-btn').addEventListener('click', () => {
        renderProfileScreen();
    });

    resultsContainer.querySelector('#continue-swiping-from-results').addEventListener('click', () => {
        showAppScreen('swipe');
        renderSwipe();
    });

    showAppScreen('results');
}

/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
/* =-=-=-=-=-=- FIN BLOC MODIFIÃ‰ : renderResultsScreen (Lien mÃªme page) =-=-=-=-=-=- */
/* =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */
function bindGlobalEvents() {
    DOM.buttons.start.addEventListener('click', transitionToApp);

    const backBtn = document.getElementById('back-btn');
    if (backBtn) {
        backBtn.addEventListener('click', handleBackStep);
    }
    
    DOM.buttons.reset.addEventListener('click', () => {
        if (confirm("Voulez-vous vraiment tout rÃ©initialiser ? Votre profil et votre historique seront effacÃ©s.")) {
            localStorage.removeItem('carnematch_session');
            localStorage.removeItem('mets_journal');
            location.reload();
        }
    });
    
    document.addEventListener("keydown", (e) => {
        const modalOpen = document.querySelector('.modal-overlay.is-visible');
        const swipeScreen = document.querySelector('#swipe-screen');
        if (modalOpen || !swipeScreen || !swipeScreen.classList.contains('active')) return;

        const activeCard = document.querySelector('.card.is-active');
        if (!activeCard) return;

        let direction = null;
        if (e.key === "ArrowRight") direction = 1;
        else if (e.key === "ArrowLeft") direction = -1;

        if (direction !== null) {
            e.preventDefault();
            const choiceEl = activeCard.querySelector(direction === 1 ? '.like' : '.nope');
            if (choiceEl) {
                choiceEl.style.transition = "opacity 0.15s ease";
                choiceEl.style.opacity = 1;
                setTimeout(() => {
                    choiceEl.style.opacity = 0;
                    animateSwipe(activeCard, direction);
                }, 150);
            } else {
                animateSwipe(activeCard, direction);
            }
        }
    });
}
async function bindIntroEvents() {
        const introContainer = DOM.appScreens.intro;
        const dialogueEl = introContainer.querySelector('#dialogue');
        const step1 = introContainer.querySelector('#intro-step-1');
        const step2 = introContainer.querySelector('#intro-step-2');
        const nameInput = introContainer.querySelector('#name-input');
        const greetingEl = introContainer.querySelector('#intro-greeting');

        introContainer.querySelectorAll('.btn-genre').forEach(b => {
            b.addEventListener('click', e => {
                introContainer.querySelectorAll('.btn-genre').forEach(x => x.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                state.user.genre = e.currentTarget.dataset.genre;
            });
        });

        introContainer.querySelector('#btn-next-step').addEventListener('click', async () => {
            const nom = nameInput.value.trim();
            const hasNumbers = /\d/.test(nom);

            if (hasNumbers) {
                state.consecutiveNameErrors++;
                if (state.consecutiveNameErrors >= 2) {
                    await showCustomAlert({
                        title: "Insistance DÃ©tectÃ©e...",
                        text: "Ok, ok, j'ai compris ! Bienvenue, R2-D2. On va dire que vous Ãªtes un Monsieur.",
                        confirmText: "Bip Boup !"
                    });
                    state.user.nom = "R2-D2 ðŸ¤–";
                    state.user.genre = "Monsieur";
                    state.consecutiveNameErrors = 0;
                } else {
                    return showCustomAlert({
                        title: "R2-D2, c'est toi ? ðŸ¤–",
                        text: "Un prÃ©nom ne contient pas de chiffres ! (Seules les lettres sont autorisÃ©es)"
                    });
                }
            } else {
                if (!nom) return showCustomAlert({ title: "Comment vous appelez-vous ?", text: "Veuillez entrer votre prÃ©nom." });
                if (!state.user.genre) return showCustomAlert({ title: "Petite prÃ©cision...", text: "Veuillez choisir 'Monsieur' ou 'Madame'." });
                
                state.consecutiveNameErrors = 0;
                state.user.nom = nom;
if (state.user.nom === "ulyssecampiglia") { // âœ… C'est ici que la magie opÃ¨re !
                    activateDebugTools();
                }
            }

            state.user.styleNarratif = detectNarrativeStyle(state.user);
            await requestLocation(); 
            saveSession();

            const adjective = state.user.genre === 'Madame' ? 'PrÃªte' : 'PrÃªt';
            greetingEl.textContent = `EnchantÃ©, ${capitalize(state.user.nom)} ! ${adjective} Ã  trouver la perle rare ?`;
            
            step1.classList.remove('is-active');
            dialogueEl.style.opacity = '0';
            setTimeout(() => {
                step2.classList.add('is-active');
            }, 500);
        });

        introContainer.querySelector('#btn-full-start').addEventListener('click', () => {
            nextQuestion();
        });

introContainer.querySelector('#btn-fast-start').addEventListener('click', () => {
            // âœ… On saute directement Ã  la derniÃ¨re question (les interdits)
            state.currentStep = QUESTION_STEPS.length - 1; 
            showAppScreen('questions'); // âœ… On affiche l'Ã©cran des questions
            renderQuestionStep(); // âœ… On affiche la question des interdits
            // La logique existante dans renderQuestionStep/nextQuestion s'occupera de lancer le chargement aprÃ¨s cette Ã©tape.
        });
    }
   

 function bindQuestionEvents() { const q = DOM.appScreens.questions, s = QUESTION_STEPS[state.currentStep]; if (s.type === 'multi') { const n = q.querySelector('#q-next'), a = q.querySelectorAll('.answer-card'); n.disabled = true; n.style.opacity = '0.5'; n.style.cursor = 'not-allowed'; n.addEventListener('click', () => { if (!n.disabled) nextQuestion(); }); a.forEach(c => { c.addEventListener('click', () => { const v = c.dataset.value; if (state.profile.interdits === null) state.profile.interdits = []; if (v === "Aucune restriction") { state.profile.interdits = []; a.forEach(x => x.classList.remove('selected')); c.classList.add('selected'); setTimeout(() => nextQuestion(), 200); return; } q.querySelector('[data-value="Aucune restriction"]')?.classList.remove('selected'); c.classList.toggle('selected'); if (c.classList.contains('selected')) { if (!state.profile.interdits.includes(v)) state.profile.interdits.push(v); } else { state.profile.interdits = state.profile.interdits.filter(x => x !== v); } const h = q.querySelectorAll('.answer-card.selected').length > 0; n.disabled = !h; n.style.opacity = h ? '1' : '0.5'; n.style.cursor = h ? 'pointer' : 'not-allowed'; }); }); } else { q.querySelectorAll('.answer-card').forEach(c => c.addEventListener('click', e => handleChoiceSelection(e.currentTarget, parseInt(e.currentTarget.dataset.index)))); } }
   

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC Ã€ REMPLACER : bindSwipeEvents ========= */
/* ========================================================== */

function bindSwipeEvents() {
    const s = DOM.appScreens.swipe;
    const l = s.querySelector('#like-btn');
    const d = s.querySelector('#dislike-btn');
    const u = s.querySelector('#undo-btn');
    const v = document.getElementById('view-matches-btn'); // âœ… On rÃ©cupÃ¨re notre bouton

    // On utilise la technique "cloneNode" pour garantir que les Ã©couteurs d'Ã©vÃ©nements sont propres
    const nL = l.cloneNode(true); l.parentNode.replaceChild(nL, l);
    const nD = d.cloneNode(true); d.parentNode.replaceChild(nD, d);
    const nU = u.cloneNode(true); u.parentNode.replaceChild(nU, u);
    
    // âœ… On applique la mÃªme technique robuste Ã  notre bouton
    const nV = v.cloneNode(true); v.parentNode.replaceChild(nV, v);

    // On attache les Ã©vÃ©nements aux nouveaux boutons "clonÃ©s"
    nL.addEventListener('click', () => { const t = s.querySelector('.card.is-active'); if (t) animateSwipe(t, 1); });
    nD.addEventListener('click', () => { const t = s.querySelector('.card.is-active'); if (t) animateSwipe(t, -1); });
    nU.addEventListener('click', handleUndoSwipe);
    nV.addEventListener('click', renderResultsScreen); // âœ… L'Ã©vÃ©nement est maintenant correctement attachÃ© ici
}

/* ========================================================== */
/* ========= FIN DU BLOC Ã€ REMPLACER : bindSwipeEvents ========= */
/* ========================================================== */
    
    
    function handleChoiceSelection(e, i) { 
const s = QUESTION_STEPS[state.currentStep], 
o = s.options[i]; 
 state.userAnswers[s.id] = i;
if (o.set) Object.assign(state.profile, o.set);
if (o.apply) o.apply(); 
saveSession();

DOM.appScreens.questions.querySelectorAll('.answer-card').forEach(c => c.classList.remove('selected')); e.classList.add('selected'); DOM.appScreens.questions.querySelectorAll('.answer-card').forEach(c => c.style.pointerEvents = 'none'); nextQuestion();saveSession(); }
    function nextQuestion() { const c = state.currentScreen === 'intro' ? DOM.appScreens.intro : DOM.appScreens.questions; c.classList.add('is-exiting'); setTimeout(() => { if (state.currentScreen === 'intro') { showAppScreen('questions'); renderQuestionStep(); } else { state.currentStep++; renderQuestionStep(); } c.classList.remove('is-exiting'); }, 400); }
    
/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC MODIFIÃ‰ : handleUndoSwipe ========= */
/* ========================================================== */

function handleUndoSwipe() {
    if (!state.lastSwipedCard) {
        // âœ… La ligne showFeedbackMessage a Ã©tÃ© supprimÃ©e ici.
        return;
    }

    const { meat, decision } = state.lastSwipedCard;

    state.swipedProductNames.delete(meat.Produit); 
    if (decision === 1) {
        state.matches = state.matches.filter(m => m.Produit !== meat.Produit); 
    }
    
    if (state.profileHistory.length > 1) { 
        state.profileHistory.pop();
        const previousProfile = state.profileHistory[state.profileHistory.length - 1];
        Object.assign(state.profile, previousProfile); 
    }

    state.deck.unshift(meat); 
    state.lastSwipedCard = null; 

    const deckEl = DOM.appScreens.swipe.querySelector('#card-deck');
    if (deckEl) {
        deckEl.innerHTML = ''; 
        addNextCardToDeckIfNeeded(); 
        addNextCardToDeckIfNeeded(); 
        updateCardStates(); 
    }
    
    updateConvergenceGauge();
    // âœ… La ligne showFeedbackMessage a Ã©tÃ© supprimÃ©e ici.
    saveSession();
}

/* ========================================================== */
/* ========= FIN DU BLOC MODIFIÃ‰ : handleUndoSwipe ========= */
/* ========================================================== */    function initCardHammer(c) {
        if (c.hammerInitialized) return;
        c.hammerInitialized = true;
    // touchAction 'none' empÃªche le navigateur d'interprÃ©ter les gestes
    // (Ã©vite que le scroll vertical bloque / fasse 'sauter' la carte)
    const h = new Hammer(c, {
      touchAction: 'none'
    });
    // threshold rÃ©duit les faux positifs (petits mouvements)
    h.get('pan').set({ direction: Hammer.DIRECTION_HORIZONTAL, threshold: 10 }); // âœ… Force le pan horizontal uniquement

    h.on('panstart', e => {
      c.isPanning = true;
      c.dataset.panning = '1';
      // Prevent native touch scrolling while interacting with the card
      // We attach a non-passive touchmove listener so we can call preventDefault
      const prevent = function(ev) { ev.preventDefault(); };
      c._preventTouchMove = prevent;
      document.addEventListener('touchmove', prevent, { passive: false });
    });
    h.on('pan', e => handlePan(e, c));
    h.on('panend', e => {
      c.isPanning = false;
      delete c.dataset.panning;
      // remove the temporary touchmove blocker
      if (c._preventTouchMove) {
        try { document.removeEventListener('touchmove', c._preventTouchMove, { passive: false }); } catch (err) { document.removeEventListener('touchmove', c._preventTouchMove); }
        delete c._preventTouchMove;
      }
      handlePanEnd(e, c);
    });
    }
  function handlePan(e, c) {
    // Defensive guards: if an animation is playing or this card is already
    // processed, ignore pan updates to avoid race conditions.
    if (state.isAnimating || c.dataset.processed) return;

    // âœ… FIX CRITIQUE : On supprime complÃ¨tement deltaY pour Ã©viter le saut sur mobile
    c.style.transition = 'none';
    c.style.transform = `translateX(${e.deltaX}px) rotate(${e.deltaX / 20}deg)`;
    const o = Math.min(Math.abs(e.deltaX) / 100, 1);
    const likeEl = c.querySelector('.like');
    const nopeEl = c.querySelector('.nope');
    if (likeEl) likeEl.style.opacity = e.deltaX > 0 ? o : 0;
    if (nopeEl) nopeEl.style.opacity = e.deltaX > 0 ? 0 : o;
  }

  function handlePanEnd(e, c) {
    // On remet une transition pour l'animation de retour ou d'Ã©jection
    c.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
    const likeEl = c.querySelector('.like');
    const nopeEl = c.querySelector('.nope');
    if (likeEl) likeEl.style.opacity = 0;
    if (nopeEl) nopeEl.style.opacity = 0;

    // If an animation is running or the card has already been processed,
    // bail out to avoid double actions (this was causing like+match races).
    if (state.isAnimating || c.dataset.processed) {
      // Ensure card returns to neutral visual state
      c.style.transform = 'translateX(0px) rotate(0deg) scale(1)';
      return;
    }

    // Only trigger swipe if displacement exceeds threshold
    if (Math.abs(e.deltaX) > 150) {
      // Ensure this card is the top of the deck (defensive)
      const topProduit = state.deck[0] ? state.deck[0].Produit : null;
      if (c.meatData && c.meatData.Produit && c.meatData.Produit !== topProduit) {
        // Not the active data card - ignore accidental gesture
        c.style.transform = 'translateX(0px) rotate(0deg) scale(1)';
        return;
      }

      animateSwipe(c, e.deltaX > 0 ? 1 : -1);
    } else {
      // Ne PAS vider style.transform (""), Ã§a provoque un saut brutal
      // et peut laisser la carte collÃ©e Ã  gauche. On remet une valeur
      // explicite qui correspond Ã  l'Ã©tat CSS .card.is-active (scale(1)).
      c.style.transform = 'translateX(0px) rotate(0deg) scale(1)';
    }
  }

/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC MODIFIÃ‰ : animateSwipe ========= */
/* ========================================================== */

function animateSwipe(card, direction) {
  // Prevent double-processing of the same card
  if (card.dataset.processed) return;

  if (state.isAnimating) { if (state.user.nom === "ulyssecampiglia") console.warn("â›” Swipe ignorÃ© (animation en cours)."); return; } // âœ… Correction
  state.isAnimating = true;
  card.dataset.processed = '1'; // mark as processed to avoid races
  card.style.pointerEvents = 'none';

    const meat = state.deck[0];
    if (!meat) { 
        state.isAnimating = false;
        return;
    }

    if (direction) {
        anime({
            targets: card,
            translateX: direction * 500,
            rotate: direction * 30,
            opacity: 0,
            duration: 400,
            easing: 'easeInQuad',
            complete: () => {
                card.remove();

                if (direction === 1) {
                    const score = calculateScore(meat, state.profile);
                    state.matches.push({ product: meat, score: score });
                }

                state.lastSwipedCard = { meat, decision: direction };
                state.swipedProductNames.add(meat.Produit);
                
                state.swipeHistory.push({ meat, decision: direction });
                if (state.swipeHistory.length > 10) state.swipeHistory.shift();
                
                state.deck.shift(); 
                
                adaptProfileOnMatch(meat, direction === 1);
                state.profileHistory.push(JSON.parse(JSON.stringify(state.profile)));
                if (state.profileHistory.length > 20) state.profileHistory.shift();
                
                // âœ… Les deux lignes suivantes qui gÃ©raient le feedback ont Ã©tÃ© supprimÃ©es.
                
                updateConvergenceGauge(); 

                const minSwipesForHint = 4;
                if (state.swipeHistory.length >= minSwipesForHint) {
                    const currentHint = generateConvergenceHint();
                    
                    if (currentHint.text !== state.lastHintPresented && currentHint.isSignificant) {
                        state.hasNewHint = true;
                        updateConvergenceGauge();
                    }
                }

        if (direction === 1 && checkForConvergence()) {
          const deckEl = document.querySelector('#card-deck');
          const savedMeat = meat;
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              if (!checkForConvergence()) {
                saveSession();
                return;
              }
              const finalCardElement = createCard(savedMeat, deckEl);
              if (finalCardElement) {
                finalCardElement.classList.add('is-active');
                triggerFinalMatchAnimation(finalCardElement);
              } else {
                renderProfileScreen();
              }
              saveSession();
            });
          });
          state.isAnimating = false;
          return;
        }
                
                addNextCardToDeckIfNeeded();
                updateCardStates();
                saveSession();
                
                state.isAnimating = false;
            }
        });
    } else {
        state.isAnimating = false;
    }
}

/* ========================================================== */
/* ========= FIN DU BLOC MODIFIÃ‰ : animateSwipe ========= */
/* ========================================================== */
    function capitalize(s) {
        if (typeof s !== 'string' || !s) return '';
        return s.charAt(0).toUpperCase() + s.slice(1);
    }

function saveSession() {
    try {
        const sessionData = {
            user: state.user,
            profile: state.profile,
            currentStep: state.currentStep,
            currentScreen: state.currentScreen,
            deck: state.deck,
            matches: state.matches,
            convergenceMatches: state.convergenceMatches, // On sauvegarde aussi les vrais matchs
            swipedProductNames: Array.from(state.swipedProductNames),
            profileHistory: state.profileHistory
        };
        localStorage.setItem('carnematch_session', JSON.stringify(sessionData));
        console.log(`%cðŸ’¾ SESSION SAUVEGARDÃ‰E`, 'color: #2de9a1; font-weight: bold; background: #1a1614; padding: 2px 5px; border-radius: 3px;', `| Ã‰cran: ${state.currentScreen}`, `| Cartes restantes: ${state.deck.length}`, `| Prochaine carte: ${state.deck.length > 0 ? state.deck[0].Produit : 'Aucune'}`);
    } catch (e) {
        console.error("Sauvegarde de session Ã©chouÃ©e:", e);
    }
}
function restoreSwipeScreen() {
    showView('app');
    showAppScreen('swipe');
    DOM.appScreens.swipe.innerHTML = `
        <div class="convergence-gauge-container">
            <div class="convergence-gauge-label">
                Affinement du profil
                <span id="convergence-help-btn" class="help-icon" title="Comment Ã§a marche ?">?</span>
                <span id="coach-popup">votre coach a des astuces pour vous ! âž”</span>
            </div>
            <div class="convergence-gauge-bar">
                <div class="convergence-gauge-fill" id="convergence-fill"></div>
            </div>
            <div class="convergence-gauge-percent" id="convergence-percent">0%</div>
        </div>
        <div id="feedback-toast" class="feedback-toast"></div>
        <div class="card-deck" id="card-deck"></div>
        <div class="actions"><button class="action-btn undo" id="undo-btn">â†©ï¸</button><button class="action-btn dislike" id="dislike-btn">âŒ</button><button class="action-btn like" id="like-btn">â¤ï¸</button></div>`;
    
    bindSwipeEvents();


    
    document.getElementById('convergence-help-btn').addEventListener('click', () => {
        const hint = generateConvergenceHint();
        showCustomAlert(hint);
        state.hasNewHint = false;
        state.lastHintPresented = hint.text;
        updateConvergenceGauge();
    });
    
    const cardDeckEl = DOM.appScreens.swipe.querySelector('#card-deck');
    if (!cardDeckEl) return; 

    if (state.deck && state.deck.length > 0) {
        createCard(state.deck[0], cardDeckEl);
        if (state.deck[1]) {
            createCard(state.deck[1], cardDeckEl);
        }
    }
    
    updateCardStates();
    updateConvergenceGauge();
}
async function loadAndRestoreSession() {
    try {
        const sessionJSON = localStorage.getItem('carnematch_session');
        if (!sessionJSON) {
            console.log('%cðŸ” Aucune session sauvegardÃ©e trouvÃ©e.', 'color: #f9b930;');
            return false;
        }

        const sessionData = JSON.parse(sessionJSON);
        console.log(`%cðŸ”„ SESSION TROUVÃ‰E`, 'color: #f9b930; font-weight: bold; background: #1a1614; padding: 2px 5px; border-radius: 3px;', `| Utilisateur: ${sessionData.user.nom}`, `| Ã‰cran Ã  restaurer: ${sessionData.currentScreen}`, `| Cartes Ã  restaurer: ${sessionData.deck.length}`, `| Prochaine carte: ${sessionData.deck.length > 0 ? sessionData.deck[0].Produit : 'Aucune'}`);

       const userChoseToRestore = await new Promise(resolve => {
    // âœ… CORRECTION DÃ‰FENSIVE
    let alertModal = document.getElementById('alert-modal');
    if (!alertModal) {
        console.warn("âš ï¸ Modal dâ€™alerte introuvable â€” crÃ©ation forcÃ©e par sÃ©curitÃ©.");
        alertModal = document.createElement('div');
        alertModal.id = "alert-modal";
        alertModal.className = "modal-overlay";
        alertModal.innerHTML = `
          <div class="modal-content" style="background:#1a1614;color:#F5F1E8;padding:1.5rem;border-radius:8px;max-width:400px;margin:auto;text-align:center;">
            <h2 id="alert-modal-title"></h2>
            <p id="alert-modal-text" style="margin-top:1rem;margin-bottom:1.5rem;"></p>
            <div id="alert-modal-buttons"></div>
          </div>`;
        document.body.appendChild(alertModal);
    }

    // ðŸ§© Bloc original de ton code
    document.getElementById('alert-modal-title').textContent = "Session trouvÃ©e";
    document.getElementById('alert-modal-text').innerHTML = `Reprendre oÃ¹ tu en Ã©tais, ${capitalize(sessionData.user.nom || 'invitÃ©')} ?`;
    document.getElementById('alert-modal-buttons').innerHTML = `
        <button class="modal-btn modal-btn-confirm" id="restore-yes">Reprendre</button>
        <button class="modal-btn modal-btn-secondary" id="restore-no">Recommencer</button>`;

            
            DOM.modals.alertTitle.textContent = "Session trouvÃ©e"; // âœ… On utilise les rÃ©fÃ©rences de l'objet DOM.
            DOM.modals.alertText.innerHTML = `Reprendre oÃ¹ tu en Ã©tais, ${capitalize(sessionData.user.nom || 'invitÃ©')} ?`; // âœ…
            DOM.modals.alertButtons.innerHTML = `<button class="modal-btn modal-btn-confirm" id="restore-yes">Reprendre</button><button class="modal-btn modal-btn-secondary" id="restore-no">Recommencer</button>`; // âœ…
            
            DOM.modals.alert.querySelector('#restore-yes').onclick = () => { DOM.modals.alert.classList.remove('is-visible'); resolve(true); };
            DOM.modals.alert.querySelector('#restore-no').onclick = () => { DOM.modals.alert.classList.remove('is-visible'); resolve(false); };
            DOM.modals.alert.classList.add('is-visible');
        });

        if (userChoseToRestore) {
            console.log('%câœ… Restauration acceptÃ©e. Application de l\'Ã©tat sauvegardÃ©.', 'color: #2de9a1;');
            Object.assign(state.user, sessionData.user);
            Object.assign(state.profile, sessionData.profile);
            state.currentStep = sessionData.currentStep;
            state.currentScreen = sessionData.currentScreen;
            state.deck = sessionData.deck || [];
            state.matches = sessionData.matches || [];
            state.convergenceMatches = sessionData.convergenceMatches || []; // On restaure les vrais matchs
            state.swipedProductNames = new Set(sessionData.swipedProductNames || []);
            state.profileHistory = sessionData.profileHistory || [];
            
            const screenToRestore = state.currentScreen;
            showView('app');

            if (screenToRestore === 'swipe') {
                restoreSwipeScreen();
            } else if (screenToRestore === 'questions') {
                showAppScreen('questions');
                renderQuestionStep();
            } else if (screenToRestore === 'results') {
                renderResultsScreen(); // On utilise renderResultsScreen qui est dÃ©jÃ  dÃ©fini
            } else if (screenToRestore === 'profile') {
                renderProfileScreen(); // On utilise renderProfileScreen qui est dÃ©jÃ  dÃ©fini
            } else {
                showAppScreen('intro');
                renderIntro();
            }
            return true;
        } else {
            console.log('%câŒ Restauration refusÃ©e. Suppression de la session.', 'color: #fe5269;');
            localStorage.removeItem('carnematch_session');
            localStorage.removeItem('mets_journal');
            return false;
        }
    } catch (e) {
        console.error("Erreur lors de la restauration de session:", e);
        localStorage.removeItem('carnematch_session');
        localStorage.removeItem('mets_journal');
        return false;
    }
}    
function activateDebugTools() {
    console.log('%cðŸ•µï¸â€â™‚ï¸ Mode DÃ©veloppeur ActivÃ© pour "ulyssecampiglia"', 'color: #8E44AD; font-weight: bold; font-size: 14px;');

    // --- CrÃ©ation du bouton "TEST MATCH" ---
    if (!document.getElementById('debug-match-btn')) { // âœ… On vÃ©rifie qu'il n'existe pas dÃ©jÃ 
        const debugBtn = document.createElement('button');
        debugBtn.id = 'debug-match-btn';
        debugBtn.textContent = 'âš¡ TEST MATCH';
        Object.assign(debugBtn.style, {
            position: 'fixed',
            bottom: '10px',
            left: '10px',
            zIndex: '10000',
            padding: '10px 15px',
            background: '#8E44AD',
            color: 'white',
            border: '2px solid white',
            borderRadius: '8px',
            cursor: 'pointer',
            fontFamily: "'Loyola Pro Bold', serif",
            boxShadow: '0 5px 20px rgba(0,0,0,0.5)'
        });
        debugBtn.addEventListener('click', () => {
                            const fakeCard = { meatData: ALL_PRODUCTS[Math.floor(Math.random() * ALL_PRODUCTS.length)] };
                console.log("âš¡ DÃ©clenchement manuel de l'animation de Match avec :", fakeCard.meatData.Produit);
                triggerFinalMatchAnimation(fakeCard);
            
        });
        document.body.appendChild(debugBtn);
    }

    // --- Activation du panneau de dÃ©bogage M.E.T.S ---
    const panel = document.getElementById("mets-debug-panel");
    if(panel) panel.style.display = "block"; // âœ… On rend le panneau visible

    // On attache l'Ã©couteur du clavier UNIQUEMENT en mode debug
    document.addEventListener("keydown", (e) => {
        if (e.key.toLowerCase() === "m" && panel) { // âœ… Le raccourci 'M' est maintenant conditionnel
          panel.style.display = panel.style.display === "none" ? "block" : "none";
        }
    });
}
    async function init() {
        bindGlobalEvents();

        const sessionRestored = await loadAndRestoreSession();
        if (!sessionRestored) {
            showView('welcome');
        }
        window.addEventListener('beforeunload', saveSession);
        
        setInterval(() => {
            if (state.currentScreen === 'swipe' && DOM.appScreens.swipe && DOM.appScreens.swipe.classList.contains('active')) {
                const svg = document.getElementById('profile-radar-svg');
                if (!svg) return;
                const jitter = { ...state.profile };
                const keys = ['Tendrete', 'Gout', 'Jutosite', 'Persillage'];
                const key = keys[Math.floor(Math.random() * keys.length)];
                jitter[key] = Math.max(0, Math.min(10, jitter[key] + (Math.random() - 0.5) * 0.2));
                drawRadar(jitter, 'profile-radar-svg');
            }
        }, 3000);
    }

  init();

  })(); // Close the main IIFE

}); // Close the DOMContentLoaded event listener


/* ========================================================== */
/* ========= DÃ‰BUT DU BLOC MODIFIÃ‰ : Panneau M.E.T.S Debug (Bouton Copier CorrigÃ©) ========= */
/* ========================================================== */

(function () {
  const panel = document.createElement("div");
  panel.id = "mets-debug-panel";
  Object.assign(panel.style, {
    position: 'fixed', bottom: '10px', right: '10px', width: '340px', maxHeight: '320px',
    overflowY: 'auto', fontFamily: 'monospace', fontSize: '12px', background: 'rgba(0,0,0,0.8)',
    color: '#F5F1E8', border: '1px solid #cc8956', borderRadius: '6px',
    padding: '8px 10px 10px 10px', boxShadow: '0 0 10px rgba(0,0,0,0.4)',
    display: 'none', zIndex: '9999'
  });
  document.body.appendChild(panel);

  const header = document.createElement("div");
  header.textContent = "ðŸ§­ M.E.T.S Debug (M pour masquer)";
  Object.assign(header.style, { fontWeight: 'bold', color: '#cc8956', marginBottom: '6px', position: 'relative' });
  panel.appendChild(header);

  const copyBtn = document.createElement("button");
  copyBtn.textContent = "ðŸ“‹ Copier";
  Object.assign(copyBtn.style, { position: 'absolute', top: '0', right: '85px', background: '#8B7355', color: 'white', border: 'none', padding: '3px 8px', borderRadius: '4px', cursor: 'pointer', fontSize: '11px' });
  
  const clearBtn = document.createElement("button");
  clearBtn.textContent = "ðŸ—‘ï¸ Clear";
  Object.assign(clearBtn.style, { position: 'absolute', top: '0', right: '10px', background: '#50241c', color: 'white', border: 'none', padding: '3px 8px', borderRadius: '4px', cursor: 'pointer', fontSize: '11px' });

  header.appendChild(copyBtn);
  header.appendChild(clearBtn);

  const logContainer = document.createElement("div");
  panel.appendChild(logContainer);

  copyBtn.onclick = () => {
    const journal = JSON.parse(localStorage.getItem("mets_journal") || "[]");
    if (journal.length === 0) {
      copyBtn.textContent = "âŒ Vide";
      setTimeout(() => (copyBtn.textContent = "ðŸ“‹ Copier"), 1500);
      return;
    }
    // âœ… La logique de formatage du texte a Ã©tÃ© corrigÃ©e pour correspondre au format actuel des logs.
    const text = [...journal].reverse().map(e => `[${e.time}] ${e.type} ${e.produit}\n${e.phrase}\n${e.style || 'â€”'} â€¢ ${e.phase}`).join("\n\n");
    navigator.clipboard.writeText(text).then(() => {
        copyBtn.textContent = "âœ… CopiÃ© !";
        setTimeout(() => (copyBtn.textContent = "ðŸ“‹ Copier"), 1500);
    }).catch(() => {
        copyBtn.textContent = "âš ï¸ Erreur";
        setTimeout(() => (copyBtn.textContent = "ðŸ“‹ Copier"), 1500);
    });
  };

  clearBtn.onclick = () => {
    if (!confirm("âš ï¸ Vider complÃ¨tement le journal M.E.T.S ?")) return;
    localStorage.removeItem("mets_journal");
    logContainer.innerHTML = "<i>(Journal effacÃ©)</i>";
    clearBtn.textContent = "âœ… EffacÃ©";
    setTimeout(() => (clearBtn.textContent = "ðŸ—‘ï¸ Clear"), 1500);
  };

  window.logMETS = function (entry) {
    if (!panel || !logContainer) return;
    const line = document.createElement("div");
    line.innerHTML = `<div style="margin-bottom:4px;border-bottom:1px dashed #444;padding-bottom:2px;"><span style="color:#888;">[${entry.time}]</span> <span style="color:#cc8956;">${entry.type}</span> <span style="color:#F5F1E8;">${entry.produit}</span><br><span style="color:#F5F1E8;">${entry.phrase}</span><br><span style="color:#777;">${entry.style} â€¢ ${entry.phase}</span></div>`;
    logContainer.prepend(line);
    while (logContainer.children.length > 50) {
      logContainer.removeChild(logContainer.lastChild);
    }
  };

})(); // Close the debug panel IIFE

/* ========================================================== */
/* ========= FIN DU BLOC MODIFIÃ‰ : Panneau M.E.T.S Debug (Bouton Copier CorrigÃ©) ========= */
/* ========================================================== */

</script>
</body>
